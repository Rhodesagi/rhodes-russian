<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Rhodes Russian | Поехали!</title>
  <!-- Rhodes Shared Theme -->
  <link rel="stylesheet" href="../shared/rhodes-theme.css">
  <script src="../shared/rhodes-theme.js"></script>
  <style>
    /* Russian flag colors - white, blue, red */
    :root {
      --accent-blue: #0039A6;
      --accent-red: #D52B1E;
      --accent-white: #ffffff;
    }
    
    body.dark-mode {
      --accent-blue: #4169E1;
      --accent-red: #FF6B6B;
      --accent-white: #333333;
    }

    /* Language-specific accent colors */
    .header, .logo-box {
      border-color: var(--accent-primary) !important;
      color: var(--accent-primary) !important;
    }
    .header h1, .course-title {
      color: var(--accent-primary) !important;
      text-shadow: 0 0 10px var(--accent-primary);
    }
    .btn-primary {
      background: var(--accent-blue) !important;
      border-color: var(--accent-blue) !important;
      color: white !important;
    }
    /* LEFT button: Always shows left flag color (blue) */
    #linearModeBtn {
      background: var(--accent-blue) !important;
      border-color: var(--accent-blue) !important;
      color: white !important;
    }
    /* RIGHT button: Shows right flag color (red) only when active */
    #srsModeBtn.active {
      background: var(--accent-red) !important;
      border-color: var(--accent-red) !important;
      color: white !important;
    }
    .unit-card:hover {
      border-color: var(--accent-primary) !important;
    }
    .progress-fill {
      background: var(--accent-primary) !important;
    }
    h3 {
      color: var(--accent-primary);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'VT323', 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 18px;
      line-height: 1.4;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 3px solid var(--border);
      padding: 15px 20px;
      margin-bottom: 20px;
      color: var(--text);
      background: var(--panel);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-box {
      border: 2px solid var(--border);
      padding: 5px 12px;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 3px;
    }

    .russian-flag {
      display: flex;
      flex-direction: column;
      height: 30px;
      width: 45px;
      border: 1px solid #ccc;
    }

    .russian-flag span {
      flex: 1;
    }

    .russian-flag .white { background: var(--bg-secondary); }
    .russian-flag .blue { background: var(--accent-blue); }
    .russian-flag .red { background: var(--accent-red); }

    /* Case Legend */
    .case-legend {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 10px 0;
      font-size: 11px;
      flex-wrap: wrap;
    }
    .case-item { display: flex; align-items: center; gap: 3px; }
    .case-dot { width: 10px; height: 10px; border-radius: 50%; }
    .case-nom-dot { background: var(--case-nom); }
    .case-gen-dot { background: var(--case-gen); }
    .case-dat-dot { background: var(--case-dat); }
    .case-acc-dot { background: var(--case-acc); }
    .case-ins-dot { background: var(--case-ins); }
    .case-pre-dot { background: var(--case-pre); }

    .subtitle {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Mode Selector */
    .mode-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 15px;
      border: 3px solid var(--border);
      color: var(--text);
      background: var(--panel);
      font-family: inherit;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-btn:hover {
      background: var(--bg-tertiary);
    }

    .mode-btn .mode-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }

    /* Unit Grid */
    .units-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .unit-card {
      color: var(--text);
      border: 2px solid var(--border);
      padding: 15px;
      background: var(--panel);
      cursor: pointer;
      transition: all 0.2s;
    }

    .unit-card:hover {
      transform: translateY(-2px);
      box-shadow: 4px 4px 0 var(--border);
    }

    .unit-card.completed {
      border-color: var(--success);
    }

    .unit-card.current {
      border-color: var(--accent-blue);
      border-width: 3px;
    }

    .unit-number {
      font-size: 14px;
      color: var(--text-dim);
    }

    .unit-title {
      font-size: 20px;
      margin: 5px 0;
    }

    .unit-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .progress-bar {
      flex: 1;
      height: 8px;
      background: #ddd;
      border: 1px solid var(--border);
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 14px;
      min-width: 40px;
    }

    /* Drill View */
    .drill-view {
      display: none;
      border: 3px solid var(--border);
      color: var(--text);
      background: var(--panel);
      padding: 20px;
    }

    .drill-view.active {
      display: block;
    }

    .drill-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .drill-type {
      font-size: 14px;
      padding: 3px 8px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .drill-content {
      margin-bottom: 20px;
    }

    .prompt {
      font-size: 22px;
      padding: 15px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      margin-bottom: 15px;
    }

    .prompt-fr {
      color: var(--accent-blue);
    }

    .prompt-en {
      font-size: 16px;
      color: var(--text-dim);
      margin-top: 5px;
    }

    /* Input Area */
    .input-area {
      margin-bottom: 20px;
    }

    .input-area input {
      width: 100%;
      padding: 15px;
      font-family: inherit;
      font-size: 20px;
      color: var(--text);
      border: 3px solid var(--border);
      outline: none;
    }

    .input-area input:focus {
      border-color: var(--accent-blue);
    }

    .input-area input.correct {
      border-color: var(--success);
      background: var(--green-bg);
    }

    .input-area input.incorrect {
      border-color: var(--error);
      background: var(--red-bg);
    }

    /* Feedback */
    .feedback {
      padding: 15px;
      margin-bottom: 15px;
      border: 2px solid var(--border);
      display: none;
    }

    .feedback.show {
      display: block;
    }

    .feedback.success {
      background: var(--green-bg);
      border-color: var(--success);
    }

    .feedback.error {
      background: var(--red-bg);
      border-color: var(--error);
    }

    .feedback-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .feedback-detail {
      font-size: 16px;
    }

    .drill-link {
      display: inline-block;
      margin-top: 10px;
      padding: 5px 10px;
      background: var(--accent-blue);
      color: white;
      text-decoration: none;
      font-size: 14px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
    }

    .btn {
      color: var(--text);
      padding: 12px 25px;
      font-family: inherit;
      font-size: 18px;
      border: 2px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--bg-tertiary);
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .btn-primary:hover {
      background: #001a75;
    }

    /* Register Toggle */
    .register-toggle {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }

    .register-btn {
      padding: 8px 15px;
      font-family: inherit;
      font-size: 14px;
      border: 2px solid var(--border);
      background: var(--panel);
      cursor: pointer;
    }

    .register-btn.active {
      background: var(--accent-blue);
      color: white;
    }

    /* Stats */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      margin-bottom: 20px;
      font-size: 14px;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* SRS Mode specific */
    .srs-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .srs-stat-card {
      border: 2px solid var(--border);
      padding: 15px;
      text-align: center;
      background: var(--panel);
    }

    .srs-stat-value {
      font-size: 32px;
      color: var(--accent-blue);
    }

    .srs-stat-label {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Audio button */
    .audio-btn {
      width: 40px;
      height: 40px;
      border: 2px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .audio-btn:hover {
      background: var(--bg-tertiary);
    }

    /* Microphone button */
    .mic-btn {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      font-size: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .mic-btn:hover {
      background: var(--bg-tertiary);
    }

    .mic-btn.recording {
      background: var(--error);
      border-color: var(--error);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .mic-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Hands-free mode toggle */
    .hands-free-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
    }

    .hands-free-toggle input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .input-with-mic {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-with-mic input {
      flex: 1;
    }

    .voice-status {
      font-size: 14px;
      color: var(--text-dim);
      text-align: center;
      margin-top: 5px;
      min-height: 20px;
    }

    /* Keyboard hints */
    .keyboard-hints {
      font-size: 12px;
      color: var(--text-dim);
      text-align: center;
      margin-top: 20px;
    }

    kbd {
      padding: 2px 6px;
      border: 1px solid #ccc;
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
  </style>
</head>
<body data-lang="russian">
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="russian-flag">
          <span class="white"></span>
          <span class="blue"></span>
          <span class="red"></span>
        </div>
        <div class="logo-box">RHODES RUSSIAN</div>
      </div>
      <div class="subtitle">BY RHODES — Поехали!</div>
      <!-- HIDDEN FOR NOW: Export/Import functionality preserved but UI hidden -->
      <div style="display: none; gap: 8px;">
        <button onclick="exportProgress()" style="font-family: inherit; font-size: 12px; padding: 4px 8px; cursor: pointer; background: var(--bg-secondary); border: 1px solid #333;">Export</button>
        <button onclick="document.getElementById('importFile').click()" style="font-family: inherit; font-size: 12px; padding: 4px 8px; cursor: pointer; background: var(--bg-secondary); border: 1px solid #333;">Import</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importProgress(event)">
      </div>
    </header>

    <!-- Case Legend (6 Russian cases) -->
    <div class="case-legend">
      <div class="case-item"><span class="case-dot case-nom-dot"></span>И.п.</div>
      <div class="case-item"><span class="case-dot case-gen-dot"></span>Р.п.</div>
      <div class="case-item"><span class="case-dot case-dat-dot"></span>Д.п.</div>
      <div class="case-item"><span class="case-dot case-acc-dot"></span>В.п.</div>
      <div class="case-item"><span class="case-dot case-ins-dot"></span>Т.п.</div>
      <div class="case-item"><span class="case-dot case-pre-dot"></span>П.п.</div>
    </div>

    <!-- Mode Selector -->
    <div class="mode-selector">
      <button class="mode-btn active" id="linearModeBtn" onclick="setMode('linear')">
        <span class="mode-icon">&#9654;</span>
        LINEAR
        <span style="font-size: 12px; display: block;">Unit by unit</span>
      </button>
      <button class="mode-btn" id="srsModeBtn" onclick="setMode('srs')">
        <span class="mode-icon">&#8634;</span>
        SRS
        <span style="font-size: 12px; display: block;">Spaced repetition</span>
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat"><strong>Units:</strong> <span id="unitsComplete">0</span>/30</div>
      <div class="stat"><strong>Vocab:</strong> <span id="vocabLearned">0</span></div>
      <div class="stat"><strong>Streak:</strong> <span id="currentStreak">0</span> days</div>
      <div class="stat"><strong>Accuracy:</strong> <span id="accuracy">0</span>%</div>
    </div>

    <!-- Linear Mode: Unit Grid -->
    <div id="linearView">
      <h2 style="margin-bottom: 15px;">Уроки 0-30 | Units 0-30</h2>
      <div class="units-grid" id="unitsGrid">
        <!-- Units populated by JS -->
      </div>
    </div>

    <!-- SRS Mode: Stats + Queue -->
    <div id="srsView" style="display: none;">
      <div class="srs-stats">
        <div class="srs-stat-card">
          <div class="srs-stat-value" id="dueToday">0</div>
          <div class="srs-stat-label">DUE TODAY</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-value" id="newCards">0</div>
          <div class="srs-stat-label">NEW</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-value" id="reviewCards">0</div>
          <div class="srs-stat-label">REVIEW</div>
        </div>
        <div class="srs-stat-card">
          <div class="srs-stat-value" id="masteredCards">0</div>
          <div class="srs-stat-label">MASTERED</div>
        </div>
      </div>
      <button class="btn btn-primary" style="width: 100%; font-size: 24px; padding: 20px;" onclick="startSRSSession()">
        START REVIEW SESSION
      </button>
    </div>

    <!-- Unit Detail View -->
    <div id="unitDetailView" style="display: none;">
      <button class="btn" onclick="closeUnitDetail()" style="margin-bottom: 15px;">&#8592; Back to Units</button>
      <h2 id="unitDetailTitle" style="margin-bottom: 15px;">UNIT 1: Dans la rue</h2>

      <!-- Dialogue Section -->
      <div class="unit-section" id="dialogueSection">
        <h3 style="margin-bottom: 10px; color: var(--accent-blue);">&#128172; DIALOGUE</h3>
        <div id="dialogueContent" style="background: var(--bg-tertiary); border: 2px solid var(--border); padding: 15px; margin-bottom: 15px; font-size: 16px; line-height: 1.8;">
          <!-- Dialogue lines populated by JS -->
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn" onclick="playDialogue()">&#128266; Play Dialogue</button>
          <button class="btn btn-primary" onclick="startDialogueDrills()">&#9998; Practice Dialogue</button>
        </div>
      </div>

      <!-- Grammar Introduction -->
      <div class="unit-section" id="grammarIntroSection" style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px; color: var(--accent-blue);">&#128218; GRAMMAR POINTS</h3>
        <div id="grammarIntroContent" style="background: #fff9e6; border: 2px solid #ffc107; padding: 15px; margin-bottom: 20px;">
          <!-- Grammar intro populated by JS -->
        </div>
      </div>

      <!-- Drills Section -->
      <div class="unit-section" id="drillsSection" style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px; color: var(--accent-blue);">&#9998; DRILLS</h3>
        <p style="color: var(--text-dim); margin-bottom: 15px;"><span id="drillCount">0</span> sentences to practice</p>
        <button class="btn btn-primary" style="width: 100%; font-size: 20px; padding: 15px;" onclick="startUnitDrills()">
          START DRILLS &#10140;
        </button>
      </div>
    </div>

    <!-- Drill View (shared between modes) -->
    <div class="drill-view" id="drillView">
      <div class="drill-header">
        <div>
          <span class="drill-type" id="drillType">SUBSTITUTION</span>
          <span id="drillProgress">1 / 10</span>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="audio-btn" onclick="playAudio('ru')" title="Play Russian">&#127467;&#127479;</button>
          <button class="audio-btn" onclick="playAudio('en')" title="Play English">&#127468;&#127463;</button>
          <button class="btn" onclick="closeDrill()">&#10005; Close</button>
        </div>
      </div>

      <!-- Mode Toggles -->
      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div class="register-toggle">
          <button class="register-btn active" id="formalBtn" onclick="setRegister('formal')">FORMAL (vous)</button>
          <button class="register-btn" id="informalBtn" onclick="setRegister('informal')">INFORMAL (tu)</button>
        </div>
        <div class="register-toggle">
          <button class="register-btn" id="repeatBtn" onclick="setDrillMode('repeat')">REPEAT</button>
          <button class="register-btn active" id="translateBtn" onclick="setDrillMode('translate')">TRANSLATE</button>
        </div>
      </div>

      <!-- Grammar Hints (shown before prompt in translate mode) -->
      <div id="grammarHints" style="background: #e8f4e8; border: 2px solid #28a745; padding: 10px 15px; margin-bottom: 15px; font-size: 14px;">
        <strong style="color: var(--green);">&#128161; You'll need:</strong>
        <span id="hintsContent">verb "être" conjugated, greeting phrase</span>
      </div>

      <!-- Drill Content -->
      <div class="drill-content">
        <div class="prompt">
          <div class="prompt-en" id="promptEn" style="font-size: 20px; color: var(--text);">I'm happy to meet you.</div>
          <div class="prompt-fr" id="promptFr" style="color: var(--accent-blue); margin-top: 8px; display: none;">Je suis heureux de faire votre connaissance.</div>
        </div>
      </div>

      <!-- Hands-free mode toggle -->
      <div class="hands-free-toggle">
        <input type="checkbox" id="handsFreeMode">
        <label for="handsFreeMode">HANDS-FREE MODE</label>
        <span style="margin-left: 20px;">
          <input type="checkbox" id="slowMode">
          <label for="slowMode">SLOW (more time to respond)</label>
        </span>
      </div>

      <!-- Input -->
      <div class="input-area">
        <div class="input-with-mic">
          <input type="text" id="userInput" placeholder="Type or speak your answer in Russian..." autocomplete="off" spellcheck="false">
          <button class="mic-btn" id="micBtn" onclick="toggleVoiceInput()" title="Click to speak">&#127908;</button>
        </div>
        <div class="voice-status" id="voiceStatus"></div>
        <!-- Cyrillic Keyboard -->
        <div class="cyrillic-keyboard" style="display: flex; flex-direction: column; gap: 3px; margin-top: 8px;">
          <div style="display: flex; justify-content: center; gap: 2px;">
            <button type="button" class="accent-key" onclick="insertChar('й')">й</button>
            <button type="button" class="accent-key" onclick="insertChar('ц')">ц</button>
            <button type="button" class="accent-key" onclick="insertChar('у')">у</button>
            <button type="button" class="accent-key" onclick="insertChar('к')">к</button>
            <button type="button" class="accent-key" onclick="insertChar('е')">е</button>
            <button type="button" class="accent-key" onclick="insertChar('н')">н</button>
            <button type="button" class="accent-key" onclick="insertChar('г')">г</button>
            <button type="button" class="accent-key" onclick="insertChar('ш')">ш</button>
            <button type="button" class="accent-key" onclick="insertChar('щ')">щ</button>
            <button type="button" class="accent-key" onclick="insertChar('з')">з</button>
            <button type="button" class="accent-key" onclick="insertChar('х')">х</button>
            <button type="button" class="accent-key" onclick="insertChar('ъ')">ъ</button>
          </div>
          <div style="display: flex; justify-content: center; gap: 2px;">
            <button type="button" class="accent-key" onclick="insertChar('ф')">ф</button>
            <button type="button" class="accent-key" onclick="insertChar('ы')">ы</button>
            <button type="button" class="accent-key" onclick="insertChar('в')">в</button>
            <button type="button" class="accent-key" onclick="insertChar('а')">а</button>
            <button type="button" class="accent-key" onclick="insertChar('п')">п</button>
            <button type="button" class="accent-key" onclick="insertChar('р')">р</button>
            <button type="button" class="accent-key" onclick="insertChar('о')">о</button>
            <button type="button" class="accent-key" onclick="insertChar('л')">л</button>
            <button type="button" class="accent-key" onclick="insertChar('д')">д</button>
            <button type="button" class="accent-key" onclick="insertChar('ж')">ж</button>
            <button type="button" class="accent-key" onclick="insertChar('э')">э</button>
          </div>
          <div style="display: flex; justify-content: center; gap: 2px;">
            <button type="button" class="accent-key" onclick="insertChar('я')">я</button>
            <button type="button" class="accent-key" onclick="insertChar('ч')">ч</button>
            <button type="button" class="accent-key" onclick="insertChar('с')">с</button>
            <button type="button" class="accent-key" onclick="insertChar('м')">м</button>
            <button type="button" class="accent-key" onclick="insertChar('и')">и</button>
            <button type="button" class="accent-key" onclick="insertChar('т')">т</button>
            <button type="button" class="accent-key" onclick="insertChar('ь')">ь</button>
            <button type="button" class="accent-key" onclick="insertChar('б')">б</button>
            <button type="button" class="accent-key" onclick="insertChar('ю')">ю</button>
            <button type="button" class="accent-key" onclick="insertChar('ё')">ё</button>
          </div>
        </div>
      </div>

      <!-- Feedback -->
      <div class="feedback" id="feedback">
        <div class="feedback-title" id="feedbackTitle">Oops!</div>
        <div class="feedback-detail" id="feedbackDetail"></div>
        <a class="drill-link" id="drillLink" style="display: none;">Review this grammar point</a>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="btn" onclick="showHint()">HINT</button>
        <button class="btn" onclick="skipDrill()">SKIP</button>
        <button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()">CHECK</button>
        <button class="btn btn-primary" id="nextBtn" onclick="nextDrill()" style="display: none;">NEXT &#10140;</button>
      </div>

      <div class="keyboard-hints">
        <kbd>Enter</kbd> to check &nbsp; | &nbsp;
        <kbd>Tab</kbd> for hint &nbsp; | &nbsp;
        <kbd>Esc</kbd> to close
      </div>
    </div>
  </div>

  <script src="js/fsi-error.js"></script>
  <script src="js/fsi-srs.js"></script>
  <script src="js/fsi-linear.js"></script>
  <script>
    // ===========================================
    // AUDIO FEEDBACK - Correct/Incorrect Sounds
    // ===========================================
    const AudioFeedback = {
      ctx: null,
      init() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return this.ctx;
      },
      // Play a success sound (rising tone)
      correct() {
        try {
          const ctx = this.init();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(440, ctx.currentTime);  // A4
          osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.15);  // A5 (rising)
          gain.gain.setValueAtTime(0.3, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.2);
        } catch (e) {
          console.warn('Audio feedback unavailable:', e.message);
        }
      },
      // Play an error sound (descending tone)
      incorrect() {
        try {
          const ctx = this.init();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(330, ctx.currentTime);  // E4
          osc.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.2);  // A3 (falling)
          gain.gain.setValueAtTime(0.3, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.25);
        } catch (e) {
          console.warn('Audio feedback unavailable:', e.message);
        }
      }
    };

    // Cyrillic keyboard helper
    function insertChar(char) {
      const input = document.getElementById('userInput');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.substring(0, start) + char + input.value.substring(end);
      input.selectionStart = input.selectionEnd = start + 1;
      input.focus();
    }

    // Course data (loaded from JSON)
    let courseData = null;
    let drillsData = null;
    // Audio uses drill ID directly - no mapping needed
    let currentMode = 'linear';
    let currentUnit = null;
    let currentDrillIndex = 0;
    let currentDrills = [];
    let register = 'formal';
    let drillMode = 'translate';  // 'translate' or 'repeat'
    let sessionCorrect = 0;
    let sessionTotal = 0;
    let retryMode = false;  // After wrong answer, user must retype correctly
    let retryExpected = '';

    // Grammar hint patterns - Russian grammar points
    const GRAMMAR_HINTS = {
      'nominative': 'Nominative case (И.п.) - subject',
      'genitive': 'Genitive case (Р.п.) - possession, negation',
      'dative': 'Dative case (Д.п.) - indirect object, нужно/можно',
      'accusative': 'Accusative case (В.п.) - direct object',
      'instrumental': 'Instrumental case (Т.п.) - with, means',
      'prepositional': 'Prepositional case (П.п.) - location, about',
      'быть': 'verb быть (to be) - omitted in present',
      'есть': 'У меня есть... (I have...)',
      'хотеть': 'verb хотеть (я хочу, ты хочешь, он хочет...)',
      'идти': 'motion verb идти/ходить (going on foot)',
      'ехать': 'motion verb ехать/ездить (going by transport)',
      'aspect': 'verbal aspect (imperfective/perfective)',
      'past': 'past tense (он читал, она читала, они читали)',
      'future': 'future tense (буду + infinitive OR perfective present)',
      'conditional': 'conditional mood (если бы + past + бы + past)'
    };

    // Generate grammar hints based on sentence content
    function generateGrammarHints(russian, english) {
      const hints = [];
      const frLower = russian.toLowerCase();
      const enLower = english.toLowerCase();

      // Detect verbs and grammar patterns
      if (frLower.includes(' suis ') || frLower.includes(' es ') || frLower.includes(' est ') || frLower.includes(' sont ')) {
        hints.push(GRAMMAR_HINTS['être']);
      }
      if (frLower.includes(' ai ') || frLower.includes(' as ') || frLower.includes(' a ') || frLower.includes(' avez ')) {
        hints.push(GRAMMAR_HINTS['avoir']);
      }
      if (frLower.includes(' vais ') || frLower.includes(' vas ') || frLower.includes(' va ') || frLower.includes(' allez ')) {
        hints.push(GRAMMAR_HINTS['aller']);
      }
      if (frLower.includes(' fais ') || frLower.includes(' fait ') || frLower.includes(' faites ')) {
        hints.push(GRAMMAR_HINTS['faire']);
      }
      if (frLower.includes(' veux ') || frLower.includes(' veut ') || frLower.includes(' voulez ') || frLower.includes(' voudrais ')) {
        hints.push(GRAMMAR_HINTS['vouloir']);
      }
      if (frLower.includes(' peux ') || frLower.includes(' peut ') || frLower.includes(' pouvez ')) {
        hints.push(GRAMMAR_HINTS['pouvoir']);
      }
      if (frLower.includes('ne ') && frLower.includes(' pas')) {
        hints.push(GRAMMAR_HINTS['negation']);
      }
      if (frLower.includes('est-ce que') || frLower.includes('-vous') || frLower.includes('-il') || frLower.includes('-elle')) {
        hints.push(GRAMMAR_HINTS['question']);
      }
      if (frLower.includes(' mon ') || frLower.includes(' ma ') || frLower.includes(' mes ') || frLower.includes(' votre ') || frLower.includes(' vos ')) {
        hints.push(GRAMMAR_HINTS['possessive']);
      }
      if (frLower.includes(' heure') || enLower.includes('time') || enLower.includes("o'clock")) {
        hints.push(GRAMMAR_HINTS['time']);
      }

      // Default hint if none detected
      if (hints.length === 0) {
        hints.push('basic vocabulary and sentence structure');
      }

      return hints.slice(0, 3).join(', ');  // Max 3 hints
    }

    // Set drill mode (translate vs repeat)
    function setDrillMode(mode) {
      drillMode = mode;
      document.getElementById('repeatBtn').classList.toggle('active', mode === 'repeat');
      document.getElementById('translateBtn').classList.toggle('active', mode === 'translate');
      updateDrillDisplay();
    }

    // Storage keys
    const STORAGE_KEY = 'allonsy_fsi_progress';
    const SYNC_KEY = 'fsi_russian_sync';

    // ===========================================
    // SRS STORAGE SYSTEM
    // ===========================================

    const SRS_DEFAULTS = {
      interval: 1, ease: 2.5, reps: 0, lapses: 0,
      due: null, lastReview: null, state: 'new'
    };

    const Storage = {
      data: null,

      async init() {
        this.data = await this.load();
        console.log('Storage loaded:', Object.keys(this.data.cards || {}).length, 'cards');
        return this.data;
      },

      async load() {
        // Try chrome.storage.sync first (cross-device)
        if (typeof chrome !== 'undefined' && chrome.storage?.sync) {
          try {
            const result = await chrome.storage.sync.get(SYNC_KEY);
            if (result[SYNC_KEY]) return result[SYNC_KEY];
          } catch (e) {}
        }
        // Try main localStorage
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) try { return JSON.parse(saved); } catch (e) {}
        // Try recovering from backups
        const recovered = await this.recover();
        if (recovered) {
          console.log('Recovered from backup!');
          return recovered;
        }
        return {
          version: 2, cards: {}, unitProgress: {},
          stats: { totalReviews: 0, streak: 0, lastStudyDate: null },
          settings: { newCardsPerDay: 20, reviewsPerDay: 100 }
        };
      },

      async save() {
        if (!this.data) return;

        // Save current state
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));

        // Auto-backup: keep last 10 versions with timestamps
        const backupKey = 'fsi_backup_' + new Date().toISOString().split('T')[0];
        const allBackups = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key?.startsWith('fsi_backup_')) allBackups.push(key);
        }
        // Save today's backup (overwrites same-day)
        localStorage.setItem(backupKey, JSON.stringify(this.data));
        // Keep only last 10 daily backups
        allBackups.sort().reverse();
        allBackups.slice(10).forEach(key => localStorage.removeItem(key));

        // Chrome storage sync (cross-device)
        if (typeof chrome !== 'undefined' && chrome.storage?.sync) {
          try { await chrome.storage.sync.set({ [SYNC_KEY]: this.data }); }
          catch (e) { /* quota exceeded is ok, localStorage works */ }
        }

        // Chrome storage local (larger, 5MB)
        if (typeof chrome !== 'undefined' && chrome.storage?.local) {
          try { await chrome.storage.local.set({ fsi_local_backup: this.data }); }
          catch (e) { /* fallback to localStorage */ }
        }
      },

      // Recover from any available backup
      async recover() {
        // Try chrome.storage.local first (most recent)
        if (typeof chrome !== 'undefined' && chrome.storage?.local) {
          try {
            const result = await chrome.storage.local.get('fsi_local_backup');
            if (result.fsi_local_backup) return result.fsi_local_backup;
          } catch (e) {}
        }
        // Try daily backups (newest first)
        const backups = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key?.startsWith('fsi_backup_')) backups.push(key);
        }
        backups.sort().reverse();
        for (const key of backups) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data?.version && data?.cards) return data;
          } catch (e) {}
        }
        return null;
      },

      getCard(drillId) {
        if (!this.data.cards[drillId]) this.data.cards[drillId] = { ...SRS_DEFAULTS };
        return this.data.cards[drillId];
      },

      reviewCard(drillId, quality) {
        const card = this.getCard(drillId);
        const now = new Date();
        card.lastReview = now.toISOString();
        card.reps++;

        if (quality < 2) {
          card.lapses++; card.interval = 1; card.state = 'learning';
        } else {
          if (card.state === 'new') { card.interval = 1; card.state = 'learning'; }
          else if (card.state === 'learning') { card.interval = 3; card.state = 'review'; }
          else {
            card.ease = Math.max(1.3, card.ease + (0.1 - (3 - quality) * (0.08 + (3 - quality) * 0.02)));
            card.interval = Math.round(card.interval * card.ease);
            if (card.interval > 180) card.state = 'mastered';
          }
        }
        const dueDate = new Date(now);
        dueDate.setDate(dueDate.getDate() + card.interval);
        card.due = dueDate.toISOString();
        this.data.stats.totalReviews++;
        this.save();
        return card;
      },

      getUnitProgress(unitId) {
        return this.data.unitProgress[unitId] || { position: 0, seenIds: [] };
      },

      setUnitProgress(unitId, position, seenId = null) {
        if (!this.data.unitProgress[unitId]) this.data.unitProgress[unitId] = { position: 0, seenIds: [] };
        this.data.unitProgress[unitId].position = position;
        if (seenId && !this.data.unitProgress[unitId].seenIds.includes(seenId)) {
          this.data.unitProgress[unitId].seenIds.push(seenId);
        }
        this.save();
      },

      getDueCards(limit = 50) {
        const now = new Date();
        return Object.entries(this.data.cards)
          .filter(([id, c]) => c.due && new Date(c.due) <= now)
          .sort((a, b) => new Date(a[1].due) - new Date(b[1].due))
          .slice(0, limit)
          .map(([id, c]) => ({ id, ...c }));
      },

      getStats() {
        const cards = Object.values(this.data.cards);
        const now = new Date();
        return {
          total: cards.length,
          newCount: cards.filter(c => c.state === 'new').length,
          learning: cards.filter(c => c.state === 'learning').length,
          review: cards.filter(c => c.state === 'review').length,
          mastered: cards.filter(c => c.state === 'mastered').length,
          dueToday: cards.filter(c => c.due && new Date(c.due) <= now).length,
          streak: this.data.stats.streak,
          totalReviews: this.data.stats.totalReviews
        };
      },

      export() { return JSON.stringify(this.data, null, 2); },

      import(jsonString) {
        try {
          const imported = JSON.parse(jsonString);
          if (!imported.version || !imported.cards) throw new Error('Invalid format');
          this.data = imported;
          this.save();
          return true;
        } catch (e) { console.error('Import failed:', e); return false; }
      },

      reset() {
        this.data = {
          version: 2, cards: {}, unitProgress: {},
          stats: { totalReviews: 0, streak: 0, lastStudyDate: null },
          settings: { newCardsPerDay: 20, reviewsPerDay: 100 }
        };
        this.save();
      }
    };

    // Export progress to JSON file
    function exportProgress() {
      const data = Storage.export();
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fsi_russian_progress_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Import progress from JSON file
    function importProgress(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        if (Storage.import(e.target.result)) {
          alert('Progress imported successfully! Refreshing...');
          location.reload();
        } else {
          alert('Import failed - invalid file format');
        }
      };
      reader.readAsText(file);
      event.target.value = '';  // Reset for re-import
    }

    // Load course data
    async function loadCourse() {
      // Always render units first (they're hardcoded) - do this BEFORE async stuff
      console.log('loadCourse() starting...');
      renderUnits();

      // Initialize storage system
      try {
        await Storage.init();
      } catch (e) {
        console.error('Storage init failed:', e);
      }

      try {
        // Load drills database
        const drillsRes = await fetch('data/drills.json?v=' + Date.now());
        drillsData = await drillsRes.json();
        console.log('Loaded drills:', drillsData.total_drills, 'drills');

        // Audio files named directly by drill ID - no mapping needed

        // Initialize SRS cards for all drills
        if (typeof FSI_SRS !== 'undefined') {
          const sentences = drillsData.drills.map(d => ({
            id: d.id,
            pos_pattern: d.pos_pattern,
            commonality: d.commonality,
            unit: d.unit
          }));
          FSI_SRS.initializeCards(sentences);
        }
        updateSRSStats();
        loadProgress();
      } catch (err) {
        console.error('Failed to load drills:', err);
        // Show error if on file:// protocol
        if (window.location.protocol === 'file:') {
          document.getElementById('unitsGrid').innerHTML = `
            <div style="grid-column: 1/-1; padding: 20px; background: var(--yellow-bg); border: 2px solid #ffc107; margin-top: 10px;">
              <strong>Cannot load drills from file:// URL</strong><br><br>
              Browsers block local file access. Use:<br><br>
              <strong>Option 1 (Recommended):</strong> Open from extension popup (FSI FRENCH COURSE button)<br>
              <strong>Option 2:</strong> Run <code>FSI_Russian_Server.bat</code><br>
              <strong>Option 3:</strong> <code>python -m http.server 8081</code> then open localhost:8081/fsi.html
            </div>
          `;
        }
      }
    }

    // Render unit cards
    function renderUnits() {
      console.log('renderUnits() called');
      const grid = document.getElementById('unitsGrid');
      if (!grid) { console.error('unitsGrid element not found!'); return; }
      grid.innerHTML = '';

      const units = [
        // Phase 1: Foundations (0-5)
        { id: 0, title_ru: 'Азбука', title_en: 'The Alphabet', grammar: [
            { title: 'Cyrillic Alphabet', desc: '33 letters: А-Я, including Ъ and Ь signs' },
            { title: 'False Friends', desc: 'В=v, Н=n, Р=r, С=s - look like English, sound different' },
            { title: 'Vowel Reduction', desc: 'Unstressed О→А, Е→И: молоко́ = [малако́]' },
            { title: 'Palatalization', desc: 'Soft sign Ь softens preceding consonant' }
          ] },
        { id: 1, title_ru: 'Привет!', title_en: 'Hello!', grammar: [
            { title: 'Basic Greetings', desc: 'Приве́т (informal), Здра́вствуйте (formal)' },
            { title: 'Self Introduction', desc: 'Меня́ зову́т... (My name is...)' },
            { title: 'Formal vs Informal', desc: 'Ты (informal) vs Вы (formal)' }
          ] },
        { id: 2, title_ru: 'Кто это?', title_en: 'Who is this?', grammar: [
            { title: 'Personal Pronouns (Nominative)', desc: 'я, ты, он, она́, оно́, мы, вы, они́' },
            { title: 'БЫТЬ Omission', desc: 'No \'to be\' in present: Я — Ива́н (I am Ivan)' },
            { title: 'ЭТО Construction', desc: 'Э́то Ива́н. Э́то кни́га. (This is...)' },
            { title: 'Formal vs Informal', desc: 'Вы (formal) vs ты (informal)' }
          ] },
        { id: 3, title_ru: 'Что вы делаете?', title_en: 'What do you do?', grammar: [
            { title: 'Nominative Case', desc: 'Subject case: Студе́нт чита́ет.' },
            { title: 'Gender Recognition', desc: 'Masc: consonant/-й, Fem: -а/-я, Neut: -о/-е' },
            { title: 'Plurals (Nominative)', desc: '-ы/-и: студе́нт→студе́нты' }
          ] },
        { id: 4, title_ru: 'Я говорю...', title_en: 'I speak...', grammar: [
            { title: '1st Conjugation Verbs', desc: 'чита́ть: чита́ю, чита́ешь, чита́ет, чита́ем' },
            { title: 'Present Tense Formation', desc: 'Remove infinitive ending, add personal endings' },
            { title: 'Accusative Case (intro)', desc: 'Direct object: Я чита́ю кни́гу.' }
          ] },
        { id: 5, title_ru: 'Повторение', title_en: 'Review 1', grammar: [
            { title: '2nd Conjugation Verbs', desc: 'говори́ть: говорю́, говори́шь, говори́т' },
            { title: 'Possessive Pronouns', desc: 'мой/моя́/моё/мои́, твой, его́, её, наш, ваш, их' },
            { title: 'Numbers 1-10', desc: 'оди́н, два, три, четы́ре, пять...' }
          ] },
        // Phase 2: Cases I (6-10)
        { id: 6, title_ru: 'У меня есть...', title_en: 'I have...', grammar: [
            { title: 'Review Unit', desc: 'Consolidation of Units 0-5' }
          ] },
        { id: 7, title_ru: 'Где?', title_en: 'Where?', grammar: [
            { title: 'Genitive Case (intro)', desc: 'У меня́ есть... НЕТ + genitive' },
            { title: 'Genitive Singular', desc: 'Masc/Neut: -а/-я, Fem: -ы/-и' },
            { title: 'Negation with НЕТ', desc: 'У меня́ нет кни́ги.' }
          ] },
        { id: 8, title_ru: 'Нет + Genitive', title_en: 'There is no...', grammar: [
            { title: 'Prepositional Case', desc: 'Location: в/на + prep.: в го́роде, на столе́' },
            { title: 'Prepositional Singular', desc: 'Most nouns add -е' },
            { title: 'В vs НА', desc: 'В: inside, НА: on/at events' }
          ] },
        { id: 9, title_ru: 'Сколько?', title_en: 'How much?', grammar: [
            { title: 'Accusative Case (full)', desc: 'Direction: Иду́ в го́род.' },
            { title: 'Accusative Animate', desc: 'Animate masc = genitive: Ви́жу студе́нта.' },
            { title: 'Motion Verbs (intro)', desc: 'идти́ vs ходи́ть (unidirectional vs multidirectional)' }
          ] },
        { id: 10, title_ru: 'Повторение', title_en: 'Review 2', grammar: [
            { title: 'Genitive Plural', desc: '-ов/-ев, -ей, zero ending' },
            { title: 'Numbers and Cases', desc: '1+nom.sg, 2-4+gen.sg, 5-20+gen.pl' },
            { title: 'Numbers 11-100', desc: 'оди́ннадцать... два́дцать... сто' }
          ] },
        // Phase 3: Cases II (11-15)
        { id: 11, title_ru: 'Мне нужно...', title_en: 'I need...', grammar: [
            { title: 'Review Unit', desc: 'Cases: Nom, Acc, Gen, Prep' }
          ] },
        { id: 12, title_ru: 'Кому?', title_en: 'To whom?', grammar: [
            { title: 'Dative Case', desc: 'Indirect object: Я даю́ кни́гу студе́нту.' },
            { title: 'Dative Singular', desc: 'Masc/Neut: -у/-ю, Fem: -е' },
            { title: 'Verbs with Dative', desc: 'помога́ть, дава́ть, говори́ть (кому́)' }
          ] },
        { id: 13, title_ru: 'Чем? С кем?', title_en: 'With what/whom?', grammar: [
            { title: 'НРА́ВИТЬСЯ Construction', desc: 'Мне нра́вится кни́га. (lit: The book pleases me)' },
            { title: 'Impersonal Dative', desc: 'Мне хо́лодно. Ему́ интере́сно.' },
            { title: 'МО́ЖНО/НУ́ЖНО + Dative', desc: 'Мне мо́жно. Вам ну́жно.' }
          ] },
        { id: 14, title_ru: 'Все падежи', title_en: 'All Cases', grammar: [
            { title: 'Instrumental Case', desc: 'с + instrumental, писа́ть ру́чкой' },
            { title: 'Instrumental Singular', desc: 'Masc/Neut: -ом/-ем, Fem: -ой/-ей' },
            { title: 'Professions (Instrumental)', desc: 'Он рабо́тает врачо́м.' }
          ] },
        { id: 15, title_ru: 'Повторение', title_en: 'Review 3', grammar: [
            { title: 'Six-Case System', desc: 'Им.п., Род.п., Дат.п., Вин.п., Тв.п., Пр.п.' },
            { title: 'Case Selection', desc: 'Prepositions and verbs govern specific cases' }
          ] },
        // Phase 4: Practical Life (16-20)
        { id: 16, title_ru: 'В ресторане', title_en: 'At the Restaurant', grammar: [
            { title: 'Review Unit', desc: 'All six cases mastery' }
          ] },
        { id: 17, title_ru: 'В магазине', title_en: 'At the Store', grammar: [
            { title: 'Shopping Vocabulary', desc: 'Ско́лько сто́ит? Я хочу́ купи́ть...' },
            { title: 'Numbers in Context', desc: 'Using numbers with rubles: рубль, рубля́, рубле́й' }
          ] },
        { id: 18, title_ru: 'Вчера...', title_en: 'Yesterday...', grammar: [
            { title: 'Past Tense (Imperfective)', desc: 'чита́л/чита́ла/чита́ло/чита́ли - gender agreement' },
            { title: 'Past Time Markers', desc: 'вчера́, на про́шлой неде́ле' }
          ] },
        { id: 19, title_ru: 'Я сделал!', title_en: 'I did it!', grammar: [
            { title: 'Perfective Aspect', desc: 'Completed actions: сде́лал (did/made), написа́л (wrote)' },
            { title: 'Aspect Pairs', desc: 'де́лать/сде́лать, писа́ть/написа́ть' }
          ] },
        { id: 20, title_ru: 'Повторение', title_en: 'Review 4', grammar: [
            { title: 'Past Tense (Perfective)', desc: 'прочита́л/прочита́ла - completed action' },
            { title: 'Aspect Introduction', desc: 'Imperfective (process) vs Perfective (result)' },
            { title: 'Aspect Pairs', desc: 'чита́ть/прочита́ть, писа́ть/написа́ть' }
          ] },
        // Phase 5: Movement & Future (21-25)
        { id: 21, title_ru: 'Идти/Ходить', title_en: 'Going (on foot)', grammar: [
            { title: 'Unidirectional Motion', desc: 'идти́ - going one way (right now)' },
            { title: 'Multidirectional Motion', desc: 'ходи́ть - going habitually or round-trip' },
            { title: 'Motion + Destination', desc: 'Иду́ в шко́лу. Хожу́ в шко́лу ка́ждый день.' }
          ] },
        { id: 22, title_ru: 'Ехать/Ездить', title_en: 'Going (transport)', grammar: [
            { title: 'Transport Motion', desc: 'е́хать - one direction, е́здить - round trips' },
            { title: 'Vehicle Selection', desc: 'на авто́бусе, на маши́не, на по́езде' },
            { title: 'Direction vs Location', desc: 'Е́ду в Москву́ (acc.) vs Живу́ в Москве́ (prep.)' }
          ] },
        { id: 23, title_ru: 'Завтра...', title_en: 'Tomorrow...', grammar: [
            { title: 'Future with БЫТЬ', desc: 'Я бу́ду чита́ть - I will read (imperfective)' },
            { title: 'Perfective Future', desc: 'Я прочита́ю - I will read (and finish)' },
            { title: 'Future Time Words', desc: 'за́втра, послеза́втра, на сле́дующей неде́ле' }
          ] },
        { id: 24, title_ru: 'Я сделаю!', title_en: 'I will do it!', grammar: [
            { title: 'Perfective Future', desc: 'Сде́лаю - will do/complete, напишу́ - will write' },
            { title: 'Future Plans', desc: 'Expressing intentions with perfective verbs' },
            { title: 'Time Adverbs', desc: 'ско́ро (soon), по́том (then), пото́м (later)' }
          ] },
        { id: 25, title_ru: 'Повторение', title_en: 'Review 5', grammar: [
            { title: 'Motion Verbs (Unidirectional)', desc: 'идти́, е́хать, лете́ть - one direction' },
            { title: 'Motion Verbs (Multidirectional)', desc: 'ходи́ть, е́здить, лета́ть - round trips' },
            { title: 'Prefixed Motion Verbs', desc: 'вы́йти, войти́, уйти́, прийти́' }
          ] },
        // Phase 6: Mastery (26-30)
        { id: 26, title_ru: 'Если бы...', title_en: 'If only...', grammar: [
            { title: 'Conditional Mood', desc: 'Е́сли бы я знал... (If I knew...)' },
            { title: 'БЫ Particle', desc: 'Past tense + бы = hypothetical/unreal' },
            { title: 'Wishes and Regrets', desc: 'Хоте́л бы... (I would like...)' }
          ] },
        { id: 27, title_ru: 'Чтобы...', title_en: 'In order to...', grammar: [
            { title: 'Purpose Clauses', desc: 'Что́бы + infinitive/past: чтобы понима́ть' },
            { title: 'Что́бы vs Чтобы́', desc: 'что́бы (purpose) vs чтобы́ (so that)' },
            { title: 'Indirect Commands', desc: 'Я хочу́, что́бы ты прочита́л.' }
          ] },
        { id: 28, title_ru: 'Говорят, что...', title_en: 'They say that...', grammar: [
            { title: 'Indirect Speech', desc: 'Он сказа́л, что... (He said that...)' },
            { title: 'Reported Questions', desc: 'Я спроси́л, где он живёт.' },
            { title: 'Impersonal Constructions', desc: 'Говоря́т, что... (They say that...)' }
          ] },
        { id: 29, title_ru: 'Разговорный русский', title_en: 'Colloquial Russian', grammar: [
            { title: 'Colloquial Expressions', desc: 'Ну, давай!, Ладно, Короче' },
            { title: 'Particles', desc: 'же, ведь, -то, -ка for emphasis' },
            { title: 'Informal Speech', desc: 'Shortened forms, slang, discourse markers' }
          ] },
        { id: 30, title_ru: 'Финальный экзамен', title_en: 'Final Exam', grammar: [
            { title: 'Course Completion', desc: 'Russian grammar A1-B1: all cases, aspect, motion verbs' }
          ] }
      ];

      for (const unit of units) {
        const progress = getUnitProgress(unit.id);
        const card = document.createElement('div');
        card.className = 'unit-card' + (progress === 100 ? ' completed' : '');
        card.innerHTML = `
          <div class="unit-number">UNIT ${unit.id}</div>
          <div class="unit-title">${unit.title_ru}</div>
          <div style="font-size: 14px; color: var(--text-dim);">${unit.title_en}</div>
          <div class="unit-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="progress-text">${progress}%</div>
          </div>
        `;
        card.onclick = () => openUnit(unit.id);
        grid.appendChild(card);
      }
      console.log('renderUnits() completed, created', units.length, 'unit cards');
    }

    // Get unit progress from storage
    function getUnitProgress(unitId) {
      // TODO: Load from chrome.storage
      return 0;
    }

    // Load progress from storage
    function loadProgress() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const progress = JSON.parse(saved);
          console.log('Loaded progress:', Object.keys(progress.seenDrills || {}).length, 'drills seen');
        } catch (e) {
          console.warn('Failed to load progress:', e);
        }
      }
    }

    // Set learning mode
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('linearModeBtn').classList.toggle('active', mode === 'linear');
      document.getElementById('srsModeBtn').classList.toggle('active', mode === 'srs');
      document.getElementById('linearView').style.display = mode === 'linear' ? 'block' : 'none';
      document.getElementById('srsView').style.display = mode === 'srs' ? 'block' : 'none';
      document.getElementById('unitDetailView').style.display = 'none';
      document.getElementById('drillView').classList.remove('active');
    }

    // Unit data with dialogues and grammar
    const UNIT_DATA = {
  "1": {
    "title_ru": "Приве́т!",
    "title_en": "Hello!",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Здра́вствуйте!",
        "en": "Hello!"
      },
      {
        "speaker": "Б:",
        "ru": "Здра́вствуйте!",
        "en": "Hello!"
      },
      {
        "speaker": "А:",
        "ru": "Меня́ зову́т Ива́н Петро́вич. А вас?",
        "en": "My name is Ivan Petrovich. And yours?"
      },
      {
        "speaker": "Б:",
        "ru": "Меня́ зову́т Мари́я Ива́новна.",
        "en": "My name is Maria Ivanovna."
      },
      {
        "speaker": "А:",
        "ru": "О́чень прия́тно!",
        "en": "Very pleased to meet you!"
      },
      {
        "speaker": "Б:",
        "ru": "Взаи́мно.",
        "en": "Likewise."
      }
    ],
    "grammar": [
      {
        "title": "1. Personal Pronouns - Nominative Case\n\n| Russian | English | Usage |\n|---------|---------|-------|\n| я | I | Always lowercase in Russian! |\n| ты | you (informal singular) | Friends, family, children |\n| он | he | Masculine |\n| она́ | she | Feminine |\n| оно́ | it | Neuter (rare for \"it\") |\n| мы | we | |\n| вы | you (informal plural OR formal singular) | Capitalized for formal |\n| они́ | they | |\n\n**Note:** Russian \"я\" (I) is never capitalized (unlike English \"I\")!",
        "desc": ""
      }
    ]
  },
  "2": {
    "title_ru": "Кто э́то?",
    "title_en": "Who is this?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Э́то ва́ша семья́?",
        "en": "Is this your family?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, э́то моя́ семья́.",
        "en": "Yes, this is my family."
      },
      {
        "speaker": "А:",
        "ru": "Кто э́то?",
        "en": "Who is this?"
      },
      {
        "speaker": "Б:",
        "ru": "Э́то мой муж. Его́ зову́т Михаи́л.",
        "en": "This is my husband. His name is Mikhail."
      },
      {
        "speaker": "А:",
        "ru": "А э́то ва́ши де́ти?",
        "en": "And these are your children?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, э́то мой сын Па́вел и моя́ дочь А́нна.",
        "en": "Yes, this is my son Pavel and my daughter Anna."
      }
    ],
    "grammar": [
      {
        "title": "1. Gender Agreement with ЭТО\n\nЭТО doesn't change form, but related words do:\n\n| Gender | This is... | My... |\n|--------|------------|-------|\n| Masculine | Э́то студе́нт | мой студе́нт |\n| Feminine | Э́то студе́нтка | моя́ студе́нтка |\n| Neuter | Э́то письмо́ | моё письмо́ |\n| Plural | Э́то студе́нты | мои́ студе́нты |",
        "desc": ""
      }
    ]
  },
  "3": {
    "title_ru": "Что вы де́лаете?",
    "title_en": "What do you do?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "До́брый день! Что вы де́лаете?",
        "en": "Good afternoon! What are you doing?"
      },
      {
        "speaker": "Б:",
        "ru": "Я рабо́таю. Чита́ю докуме́нты.",
        "en": "I'm working. Reading documents."
      },
      {
        "speaker": "А:",
        "ru": "А где вы рабо́таете?",
        "en": "And where do you work?"
      },
      {
        "speaker": "Б:",
        "ru": "Я рабо́таю в ба́нке. А вы?",
        "en": "I work at a bank. And you?"
      },
      {
        "speaker": "А:",
        "ru": "Я рабо́таю в университе́те.",
        "en": "I work at a university."
      },
      {
        "speaker": "Б:",
        "ru": "Вы препода́ватель?",
        "en": "Are you a professor?"
      },
      {
        "speaker": "А:",
        "ru": "Да, я преподаю́ исто́рию.",
        "en": "Yes, I teach history."
      }
    ],
    "grammar": [
      {
        "title": "1. First Conjugation Verbs (-АТЬ/-ЯТЬ)\n\n**Pattern:** Remove -ть, add personal endings\n\n| Infinitive | я | ты | он/она́ | мы | вы | они́ |\n|------------|---|-------|--------|-------|-------|------|\n| чита́**ть** | чита́**ю** | чита́**ешь** | чита́**ет** | чита́**ем** | чита́**ете** | чита́**ют** |\n| рабо́та**ть** | рабо́та**ю** | рабо́та**ешь** | рабо́та**ет** | рабо́та**ем** | рабо́та**ете** | рабо́та**ют** |\n| де́ла**ть** | де́ла**ю** | де́ла**ешь** | де́ла**ет** | де́ла**ем** | де́ла**ете** | де́ла**ют** |\n| гуля́**ть** | гуля́**ю** | гуля́**ешь** | гуля́**ет** | гуля́**ем** | гуля́**ете** | гуля́**ют** |\n\n**Common First Conjugation Verbs:**\n- чита́ть (to read)\n- рабо́тать (to work)\n- де́лать (to do/make)\n- зна́ть (to know)\n- понима́ть (to understand)\n- слу́шать (to listen)\n- за́втракать (to have breakfast)\n- обе́дать (to have lunch)\n- у́жинать (to have dinner)\n- отдыха́ть (to rest)\n- гуля́ть (to walk/stroll)",
        "desc": ""
      }
    ]
  },
  "4": {
    "title_ru": "Я говорю́ по-ру́сски",
    "title_en": "I Speak Russian",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Вы говори́те по-ру́сски?",
        "en": "Do you speak Russian?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, я говорю́ по-ру́сски. А вы говори́те по-англи́йски?",
        "en": "Yes, I speak Russian. Do you speak English?"
      },
      {
        "speaker": "А:",
        "ru": "Немно́го. Я учу́ англи́йский.",
        "en": "A little. I'm learning English."
      },
      {
        "speaker": "Б:",
        "ru": "Мо́жет быть, мы мо́жем практикова́ть вме́сте?",
        "en": "Maybe we can practice together?"
      },
      {
        "speaker": "А:",
        "ru": "Отли́чная иде́я!",
        "en": "Excellent idea!"
      }
    ],
    "grammar": [
      {
        "title": "1. Second Conjugation Verbs (-ИТЬ)\n\n**Pattern:** Remove -ить, add personal endings\n\n| Infinitive | я | ты | он/она́ | мы | вы | они́ |\n|------------|---|-------|--------|-------|-------|------|\n| говор**и́ть** | говор**ю́** | говор**и́шь** | говор**и́т** | говор**и́м** | говор**и́те** | говор**я́т** |\n| люб**и́ть** | любл**ю́** | лю́б**ишь** | лю́б**ит** | лю́б**им** | лю́б**ите** | лю́б**ят** |\n| ви́д**еть** | ви́ж**у** | ви́д**ишь** | ви́д**ит** | ви́д**им** | ви́д**ите** | ви́д**ят** |\n| смотр**е́ть** | смотр**ю́** | смо́тр**ишь** | смо́тр**ит** | смо́тр**им** | смо́тр**ите** | смо́тр**ят** |\n\n**Common Second Conjugation Verbs:**\n- говори́ть (to speak)\n- люби́ть (to love) *б→бл*\n- ви́деть (to see) *д→ж*\n- смотре́ть (to watch)\n- слы́шать (to hear) *irregular*\n- учи́ть (to learn/teach)\n- помни́ть (to remember)\n- стои́ть (to cost/stand)",
        "desc": ""
      }
    ]
  },
  "6": {
    "title_ru": "У меня́ есть...",
    "title_en": "I Have...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Извини́те, у вас есть телефо́н?",
        "en": "Excuse me, do you have a phone?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, есть. А что?",
        "en": "Yes, I do. Why?"
      },
      {
        "speaker": "А:",
        "ru": "Мо́жно позвони́ть? Мой телефо́н не рабо́тает.",
        "en": "May I make a call? My phone doesn't work."
      },
      {
        "speaker": "Б:",
        "ru": "Коне́чно, пожа́луйста.",
        "en": "Of course, please."
      },
      {
        "speaker": "А:",
        "ru": "Спаси́бо большо́е!",
        "en": "Thank you very much!"
      }
    ],
    "grammar": [
      {
        "title": "1. The Possession Construction\n\n**Formula:** У + GENITIVE + есть + NOMINATIVE\n\n| Component | Function | Example |\n|-----------|----------|---------|\n| У | preposition \"at\" | У |\n| меня́ | possessor (Gen) | меня́ |\n| есть | \"there is\" | есть |\n| кни́га | thing possessed (Nom) | кни́га |\n\n**Full:** У меня́ есть кни́га. = \"At me there-is book\" = I have a book.",
        "desc": ""
      }
    ]
  },
  "7": {
    "title_ru": "Где?",
    "title_en": "Where?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Где вы живёте?",
        "en": "Where do you live?"
      },
      {
        "speaker": "Б:",
        "ru": "Я живу́ в Москве́. А вы?",
        "en": "I live in Moscow. And you?"
      },
      {
        "speaker": "А:",
        "ru": "Я живу́ в Санкт-Петербу́рге.",
        "en": "I live in Saint Petersburg."
      },
      {
        "speaker": "Б:",
        "ru": "Краси́вый го́род! Где и́менно?",
        "en": "Beautiful city! Where exactly?"
      },
      {
        "speaker": "А:",
        "ru": "В це́нтре, на Не́вском проспе́кте.",
        "en": "Downtown, on Nevsky Prospect."
      },
      {
        "speaker": "Б:",
        "ru": "О, э́то о́чень краси́вое ме́сто!",
        "en": "Oh, that's a very beautiful place!"
      }
    ],
    "grammar": [
      {
        "title": "1. Prepositional Case: Noun Endings\n\n| Gender | Nominative | Prepositional | Example |\n|--------|------------|---------------|---------|\n| Masculine hard | -∅ | -е | дом → в до́м**е** |\n| Masculine soft | -ь, -й | -е | музе́й → в музе́**е** |\n| Feminine hard | -а | -е | шко́ла → в шко́л**е** |\n| Feminine soft | -я, -ь | -е, -и | неде́ля → на неде́л**е**; дверь → на двер**и́** |\n| Neuter hard | -о | -е | окно́ → на окн**е́** |\n| Neuter soft | -е | -е | мо́ре → на мо́р**е** |",
        "desc": ""
      }
    ]
  },
  "8": {
    "title_ru": "Нет + Genitive",
    "title_en": "Negation & Absence",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "У вас есть молоко́?",
        "en": "Do you have milk?"
      },
      {
        "speaker": "Б:",
        "ru": "К сожале́нию, молока́ нет.",
        "en": "Unfortunately, there's no milk."
      },
      {
        "speaker": "А:",
        "ru": "А хлеб?",
        "en": "And bread?"
      },
      {
        "speaker": "Б:",
        "ru": "Хле́ба то́же нет.",
        "en": "There's no bread either."
      },
      {
        "speaker": "А:",
        "ru": "А что у вас есть?",
        "en": "What do you have?"
      },
      {
        "speaker": "Б:",
        "ru": "Есть ма́сло и сыр.",
        "en": "There's butter and cheese."
      },
      {
        "speaker": "А:",
        "ru": "Хорошо́, да́йте сыр.",
        "en": "Okay, give me cheese."
      }
    ],
    "grammar": [
      {
        "title": "1. НЕТ + Genitive (Existence Negation)\n\n**Formula:** НЕТ + Genitive = \"There is no...\"\n\n| Positive | Negative |\n|----------|----------|\n| Есть кни́га. (There is a book.) | Нет кни́ги. (There is no book.) |\n| Есть вре́мя. (There is time.) | Нет вре́мени. (There is no time.) |",
        "desc": ""
      }
    ]
  },
  "9": {
    "title_ru": "Ско́лько?",
    "title_en": "How Much? How Many?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Ско́лько сто́ит э́тот журна́л?",
        "en": "How much is this magazine?"
      },
      {
        "speaker": "Б:",
        "ru": "Сто пятьдеся́т рубле́й.",
        "en": "One hundred fifty rubles."
      },
      {
        "speaker": "А:",
        "ru": "А э́та кни́га?",
        "en": "And this book?"
      },
      {
        "speaker": "Б:",
        "ru": "Три́ста рубле́й.",
        "en": "Three hundred rubles."
      },
      {
        "speaker": "А:",
        "ru": "До́рого! А есть ски́дка?",
        "en": "Expensive! Is there a discount?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, де́сять проце́нтов.",
        "en": "Yes, ten percent."
      }
    ],
    "grammar": [
      {
        "title": "1. Number + Noun Agreement\n\n| Number | Noun Case | Example |\n|--------|-----------|---------|\n| 1 (оди́н/одна́/одно́) | Nom Singular | оди́н студе́нт, одна́ кни́га |\n| 2, 3, 4 | Gen Singular | два студе́нта, три кни́ги |\n| 5-20, 25-30... | Gen Plural | пять студе́нтов, де́сять книг |\n| 21, 31, 41... | Nom Singular | два́дцать оди́н студе́нт |\n| 22-24, 32-34... | Gen Singular | два́дцать два студе́нта |",
        "desc": ""
      }
    ]
  },
  "11": {
    "title_ru": "Мне ну́жно...",
    "title_en": "I Need...",
    "dialogue": [
      {
        "speaker": "Врач:",
        "ru": "Что вам ну́жно?",
        "en": "What do you need?"
      },
      {
        "speaker": "Пацие́нт:",
        "ru": "Мне пло́хо.",
        "en": "I feel bad."
      },
      {
        "speaker": "Врач:",
        "ru": "Что у вас боли́т?",
        "en": "What hurts?"
      },
      {
        "speaker": "Пацие́нт:",
        "ru": "Мне боли́т голова́.",
        "en": "I have a headache."
      },
      {
        "speaker": "Врач:",
        "ru": "Вам ну́жно отдохну́ть.",
        "en": "You need to rest."
      },
      {
        "speaker": "Пацие́нт:",
        "ru": "Спаси́бо, до́ктор.",
        "en": "Thank you, doctor."
      }
    ],
    "grammar": [
      {
        "title": "1. Dative Case: Pronoun Forms\n\n| Nominative | Dative |\n|------------|--------|\n| я | мне |\n| ты | тебе́ |\n| он | ему́ |\n| она́ | ей |\n| оно́ | ему́ |\n| мы | нам |\n| вы | вам |\n| они́ | им |\n\n**After prepositions К, ПО:** no changes (unlike genitive)",
        "desc": ""
      }
    ]
  },
  "12": {
    "title_ru": "Кому́?",
    "title_en": "To Whom?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Кому́ вы купи́ли э́тот пода́рок?",
        "en": "For whom did you buy this gift?"
      },
      {
        "speaker": "Б:",
        "ru": "Я купи́л его́ подру́ге.",
        "en": "I bought it for my girlfriend."
      },
      {
        "speaker": "А:",
        "ru": "Что вы ей подари́те?",
        "en": "What will you give her?"
      },
      {
        "speaker": "Б:",
        "ru": "Я подарю́ ей духи́.",
        "en": "I'll give her perfume."
      },
      {
        "speaker": "А:",
        "ru": "Прекра́сный вы́бор! Ей понра́вится.",
        "en": "Excellent choice! She'll like it."
      },
      {
        "speaker": "Б:",
        "ru": "Наде́юсь! За́втра её день рожде́ния.",
        "en": "I hope so! Tomorrow is her birthday."
      }
    ],
    "grammar": [
      {
        "title": "1. Verbs that Take Dative Object\n\n**\"Giving\" verbs:**\n| Verb | Meaning | Example |\n|------|---------|---------|\n| дать | give | Дай **мне** кни́гу. |\n| дари́ть/подари́ть | give (gift) | Я подари́л **ей** цветы́. |\n| показа́ть | show | Покажи́ **мне**! |\n| принести́ | bring | Принеси́ **ему́** во́ду. |\n| посла́ть | send | Я посла́л **им** письмо́. |\n\n**\"Helping/Communication\" verbs:**\n| Verb | Meaning | Example |\n|------|---------|---------|\n| помо́чь | help | Помоги́ **мне**! |\n| сказа́ть | say/tell | Скажи́ **ей** пра́вду. |\n| объясни́ть | explain | Объясни́ **мне** э́то. |\n| отве́тить | answer | Отве́ть **ему́**! |\n| позвони́ть | call | Позвони́ **ма́ме**. |\n| написа́ть | write | Напиши́ **мне**! |",
        "desc": ""
      }
    ]
  },
  "13": {
    "title_ru": "Чем? С кем?",
    "title_en": "With What? With Whom?",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Здра́вствуйте! С кем вы сего́дня?",
        "en": "Hello! Who are you with today?"
      },
      {
        "speaker": "Б:",
        "ru": "Я с колле́гой. Мы обсужда́ем прое́кт.",
        "en": "I'm with a colleague. We're discussing a project."
      },
      {
        "speaker": "А:",
        "ru": "Что буде́те есть?",
        "en": "What will you have to eat?"
      },
      {
        "speaker": "Б:",
        "ru": "Мне, пожа́луйста, ко́фе с молоко́м.",
        "en": "Coffee with milk for me, please."
      },
      {
        "speaker": "А:",
        "ru": "А ва́шему колле́ге?",
        "en": "And for your colleague?"
      },
      {
        "speaker": "Б:",
        "ru": "Ему́ чай с лимо́ном.",
        "en": "Tea with lemon for him."
      }
    ],
    "grammar": [
      {
        "title": "Instrumental Case Formation",
        "desc": ""
      }
    ]
  },
  "14": {
    "title_ru": "Все паде́жи",
    "title_en": "All Cases",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "У вас есть брат?",
        "en": "Do you have a brother?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, у меня́ есть брат.",
        "en": "Yes, I have a brother."
      },
      {
        "speaker": "А:",
        "ru": "Кем он рабо́тает?",
        "en": "What does he work as?"
      },
      {
        "speaker": "Б:",
        "ru": "Он рабо́тает врачо́м.",
        "en": "He works as a doctor."
      },
      {
        "speaker": "А:",
        "ru": "Где он рабо́тает?",
        "en": "Where does he work?"
      },
      {
        "speaker": "Б:",
        "ru": "В больни́це в Москве́.",
        "en": "In a hospital in Moscow."
      },
      {
        "speaker": "А:",
        "ru": "Вы ча́сто ви́дите его́?",
        "en": "Do you often see him?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, мы встреча́емся ка́ждую неде́лю.",
        "en": "Yes, we meet every week."
      }
    ],
    "grammar": [
      {
        "title": "Complete Declension Tables",
        "desc": ""
      }
    ]
  },
  "15": {
    "title_ru": "Повторе́ние 3",
    "title_en": "Review 3",
    "dialogue": [],
    "grammar": [
      {
        "title": "When to Use Each Case\n\n| Situation | Case | Example |\n|-----------|------|---------|\n| Subject of sentence | **Nom** | Студе́нт чита́ет. |\n| Possession (У... есть) | **Gen** | У студе́нта есть... |\n| Negation (нет...) | **Gen** | Нет студе́нта. |\n| Quantities (мно́го, ма́ло, 5+) | **Gen** | Пять студе́нтов |\n| After без, для, из, от, до | **Gen** | Без студе́нта |\n| Indirect object (to/for whom) | **Dat** | Дал студе́нту |\n| Impersonal (ну́жно, мо́жно) | **Dat** | Студе́нту ну́жно... |\n| Age expressions | **Dat** | Студе́нту 20 лет. |\n| After К | **Dat** | К студе́нту |\n| Direct object | **Acc** | Ви́жу студе́нта |\n| Direction (в/на + Acc) | **Acc** | Иду́ в университе́т |\n| Time expressions (через) | **Acc** | Че́рез час |\n| Means/instrument | **Instr** | Пишу́ ру́чкой |\n| Accompaniment (с + Instr) | **Instr** | Со студе́нтом |\n| Profession (after быть/стать) | **Instr** | Быть студе́нтом |\n| Time (у́тром, ве́чером) | **Instr** | У́тром |\n| Location (в/на + Prep) | **Prep** | В университе́те |\n| Topic (о/об + Prep) | **Prep** | О студе́нте |\n\n---",
        "desc": ""
      }
    ]
  },
  "16": {
    "title_ru": "В рестора́не",
    "title_en": "At the Restaurant",
    "dialogue": [
      {
        "speaker": "Официа́нт:",
        "ru": "До́брый ве́чер! Вот меню́.",
        "en": "Good evening! Here's the menu."
      },
      {
        "speaker": "Гость:",
        "ru": "Спаси́бо. Что вы рекоменду́ете?",
        "en": "Thank you. What do you recommend?"
      },
      {
        "speaker": "Официа́нт:",
        "ru": "Сего́дня о́чень вку́сный борщ.",
        "en": "Today the borscht is very tasty."
      },
      {
        "speaker": "Гость:",
        "ru": "Хорошо́. Я возьму́ борщ и салат.",
        "en": "Good. I'll have borscht and salad."
      },
      {
        "speaker": "Официа́нт:",
        "ru": "Что бу́дете пить?",
        "en": "What will you drink?"
      },
      {
        "speaker": "Гость:",
        "ru": "Бока́л кра́сного вина́, пожа́луйста.",
        "en": "A glass of red wine, please."
      },
      {
        "speaker": "Официа́нт:",
        "ru": "Отли́чный вы́бор!",
        "en": "Excellent choice!"
      }
    ],
    "grammar": [
      {
        "title": "Ordering with Accusative Case\n\nWhen ordering food, you use **Accusative** for what you want:\n\n| Nominative | Accusative | Example |\n|------------|------------|---------|\n| борщ (m) | борщ | Я хочу́ **борщ**. |\n| салат (m) | салат | Дайте **сала́т**. |\n| пи́цца (f) | пи́ццу | Я возьму́ **пи́ццу**. |\n| ры́ба (f) | ры́бу | Я бу́ду **ры́бу**. |\n| мя́со (n) | мя́со | Мне **мя́со**. |\n| пельме́ни (pl) | пельме́ни | Принеси́те **пельме́ни**. |",
        "desc": ""
      }
    ]
  },
  "17": {
    "title_ru": "В магази́не",
    "title_en": "At the Store",
    "dialogue": [
      {
        "speaker": "Покупа́тель:",
        "ru": "Здра́вствуйте! Ско́лько сто́ит э́та ру́башка?",
        "en": "Hello! How much is this shirt?"
      },
      {
        "speaker": "Продаве́ц:",
        "ru": "Две ты́сячи рубле́й.",
        "en": "Two thousand rubles."
      },
      {
        "speaker": "Покупа́тель:",
        "ru": "Мо́жно приме́рить?",
        "en": "May I try it on?"
      },
      {
        "speaker": "Продаве́ц:",
        "ru": "Коне́чно. Примеро́чная там.",
        "en": "Of course. The fitting room is there."
      },
      {
        "speaker": "Покупа́тель:",
        "ru": "Э́то есть в друго́м цве́те?",
        "en": "Is this available in another color?"
      },
      {
        "speaker": "Продаве́ц:",
        "ru": "Да, есть в бе́лом и в си́нем.",
        "en": "Yes, in white and blue."
      },
      {
        "speaker": "Покупа́тель:",
        "ru": "Я возьму́ си́нюю.",
        "en": "I'll take the blue one."
      }
    ],
    "grammar": [
      {
        "title": "Prices and Numbers Review\n\n| Number | + рубль (1) | + рубля́ (2-4) | + рубле́й (5+) |\n|--------|-------------|----------------|----------------|\n| 1 | оди́н рубль | — | — |\n| 2 | — | два рубля́ | — |\n| 5 | — | — | пять рубле́й |\n| 21 | два́дцать оди́н рубль | — | — |\n| 22 | — | два́дцать два рубля́ | — |\n| 100 | — | — | сто рубле́й |\n| 1000 | — | — | ты́сяча рубле́й |",
        "desc": ""
      }
    ]
  },
  "18": {
    "title_ru": "Вчера́...",
    "title_en": "Yesterday...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Что вы де́лали вчера́?",
        "en": "What did you do yesterday?"
      },
      {
        "speaker": "Б:",
        "ru": "Вчера́ я рабо́тал до́ма.",
        "en": "Yesterday I worked at home."
      },
      {
        "speaker": "А:",
        "ru": "Что вы де́лали ве́чером?",
        "en": "What did you do in the evening?"
      },
      {
        "speaker": "Б:",
        "ru": "Ве́чером я чита́л кни́гу и смотре́л телеви́зор.",
        "en": "In the evening I read a book and watched TV."
      },
      {
        "speaker": "А:",
        "ru": "А ва́ша жена́?",
        "en": "And your wife?"
      },
      {
        "speaker": "Б:",
        "ru": "Она́ гото́вила у́жин и разгова́ривала по телефо́ну.",
        "en": "She was cooking dinner and talking on the phone."
      }
    ],
    "grammar": [
      {
        "title": "Past Tense Formation\n\nRussian past tense is **SIMPLE** to form:\n\n**Formula:** Infinitive stem + Л + gender/number ending\n\n| | Singular | Plural |\n|---|----------|--------|\n| **Masculine** | -Л | -ЛИ |\n| **Feminine** | -ЛА | -ЛИ |\n| **Neuter** | -ЛО | -ЛИ |",
        "desc": ""
      }
    ]
  },
  "19": {
    "title_ru": "Я сде́лал!",
    "title_en": "I Did It!",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Вы прочита́ли отчёт?",
        "en": "Did you read (finish) the report?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, я прочита́л его́ вчера́.",
        "en": "Yes, I read (finished) it yesterday."
      },
      {
        "speaker": "А:",
        "ru": "И что вы ду́маете?",
        "en": "And what do you think?"
      },
      {
        "speaker": "Б:",
        "ru": "Я написа́л свои́ коммента́рии. Вот.",
        "en": "I wrote my comments. Here."
      },
      {
        "speaker": "А:",
        "ru": "Отли́чно! Вы всё сде́лали.",
        "en": "Excellent! You did everything."
      },
      {
        "speaker": "Б:",
        "ru": "Да, я закон́чил вчера́ ве́чером.",
        "en": "Yes, I finished yesterday evening."
      }
    ],
    "grammar": [
      {
        "title": "How Perfective Verbs Are Formed\n\nThere are several patterns:",
        "desc": ""
      }
    ]
  },
  "20": {
    "title_ru": "Повторе́ние 4",
    "title_en": "Review 4",
    "dialogue": [],
    "grammar": [
      {
        "title": "Past Tense Quick Reference\n\n| | Masculine | Feminine | Neuter | Plural |\n|---|-----------|----------|--------|--------|\n| Regular | -Л | -ЛА | -ЛО | -ЛИ |\n| Example | чита́л | чита́ла | чита́ло | чита́ли |\n| Stress shift | жил | жила́ | жило́ | жи́ли |\n| No -Л | мог | могла́ | могло́ | могли́ |",
        "desc": ""
      }
    ]
  },
  "21": {
    "title_ru": "Идти́/Ходи́ть",
    "title_en": "Going on Foot",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Здра́вствуйте! Куда́ вы идёте?",
        "en": "Hello! Where are you going?"
      },
      {
        "speaker": "Б:",
        "ru": "Я иду́ на рабо́ту.",
        "en": "I'm going to work."
      },
      {
        "speaker": "А:",
        "ru": "А куда́ вы обы́чно хо́дите обе́дать?",
        "en": "And where do you usually go for lunch?"
      },
      {
        "speaker": "Б:",
        "ru": "Я хожу́ в кафе́ о́коло о́фиса.",
        "en": "I go to a café near the office."
      },
      {
        "speaker": "А:",
        "ru": "Хорошо́! Прия́тного дня!",
        "en": "Good! Have a nice day!"
      }
    ],
    "grammar": [
      {
        "title": "ИДТИ́ - Unidirectional (One Way, Now)\n\n| Person | Present | Past |\n|--------|---------|------|\n| я | иду́ | шёл / шла |\n| ты | идёшь | шёл / шла |\n| он/она́ | идёт | шёл / шла |\n| мы | идём | шли |\n| вы | идёте | шли |\n| они́ | иду́т | шли |\n\n**Use ИДТИ́ when:**\n- Going somewhere RIGHT NOW\n- Describing a specific one-way journey\n- Narrating motion in progress",
        "desc": ""
      }
    ]
  },
  "22": {
    "title_ru": "Е́хать/Е́здить",
    "title_en": "Going by Transport",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "На чём вы е́здите на рабо́ту?",
        "en": "How do you get to work?"
      },
      {
        "speaker": "Б:",
        "ru": "Я е́зжу на метро́. А вы?",
        "en": "I take the metro. And you?"
      },
      {
        "speaker": "А:",
        "ru": "Я е́зжу на маши́не.",
        "en": "I drive."
      },
      {
        "speaker": "Б:",
        "ru": "Про́бки не меша́ют?",
        "en": "Don't traffic jams bother you?"
      },
      {
        "speaker": "А:",
        "ru": "Иногда́. Поэ́тому я вы́езжаю ра́но.",
        "en": "Sometimes. That's why I leave early."
      }
    ],
    "grammar": [
      {
        "title": "Е́ХАТЬ - Unidirectional (One Way, Now)\n\n| Person | Present | Past |\n|--------|---------|------|\n| я | е́ду | е́хал(а) |\n| ты | е́дешь | е́хал(а) |\n| он/она́ | е́дет | е́хал(а) |\n| мы | е́дем | е́хали |\n| вы | е́дете | е́хали |\n| они́ | е́дут | е́хали |",
        "desc": ""
      }
    ]
  },
  "23": {
    "title_ru": "За́втра...",
    "title_en": "Tomorrow...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Что вы бу́дете де́лать в выходны́е?",
        "en": "What will you do on the weekend?"
      },
      {
        "speaker": "Б:",
        "ru": "В суббо́ту я бу́ду рабо́тать.",
        "en": "On Saturday I'll be working."
      },
      {
        "speaker": "А:",
        "ru": "А в воскресе́нье?",
        "en": "And on Sunday?"
      },
      {
        "speaker": "Б:",
        "ru": "Бу́ду отдыха́ть до́ма. Мо́жет быть, бу́ду смотре́ть фильм.",
        "en": "I'll rest at home. Maybe I'll watch a movie."
      },
      {
        "speaker": "А:",
        "ru": "Хоро́ших выходны́х!",
        "en": "Have a good weekend!"
      }
    ],
    "grammar": [
      {
        "title": "Forming Imperfective Future\n\n**Formula:** БУ́ДУ + imperfective infinitive\n\n| Person | БЫТЬ | Example |\n|--------|------|---------|\n| я | бу́ду | Я бу́ду рабо́тать. |\n| ты | бу́дешь | Ты бу́дешь чита́ть? |\n| он/она́ | бу́дет | Он бу́дет учи́ться. |\n| мы | бу́дем | Мы бу́дем жить здесь. |\n| вы | бу́дете | Вы бу́дете отдыха́ть? |\n| они́ | бу́дут | Они́ бу́дут рабо́тать. |",
        "desc": ""
      }
    ]
  },
  "24": {
    "title_ru": "Я сде́лаю!",
    "title_en": "I Will Do It!",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Когда́ вы сде́лаете отчёт?",
        "en": "When will you finish the report?"
      },
      {
        "speaker": "Б:",
        "ru": "Я сде́лаю его́ за́втра.",
        "en": "I'll finish it tomorrow."
      },
      {
        "speaker": "А:",
        "ru": "То́чно? Вы успе́ете?",
        "en": "For sure? Will you manage?"
      },
      {
        "speaker": "Б:",
        "ru": "Да, обяза́тельно успе́ю. Обеща́ю.",
        "en": "Yes, I'll definitely manage. I promise."
      },
      {
        "speaker": "А:",
        "ru": "Хорошо́. Я позвоню́ вам за́втра ве́чером.",
        "en": "Good. I'll call you tomorrow evening."
      },
      {
        "speaker": "Б:",
        "ru": "Договори́лись.",
        "en": "Agreed."
      }
    ],
    "grammar": [
      {
        "title": "Perfective Future = Perfective Present Forms\n\n| Person | СДЕЛАТЬ | НАПИСАТЬ | ПРОЧИТАТЬ |\n|--------|---------|----------|-----------|\n| я | сде́лаю | напишу́ | прочита́ю |\n| ты | сде́лаешь | напи́шешь | прочита́ешь |\n| он/она́ | сде́лает | напи́шет | прочита́ет |\n| мы | сде́лаем | напи́шем | прочита́ем |\n| вы | сде́лаете | напи́шете | прочита́ете |\n| они́ | сде́лают | напи́шут | прочита́ют |",
        "desc": ""
      }
    ]
  },
  "25": {
    "title_ru": "Повторе́ние 5",
    "title_en": "Review 5",
    "dialogue": [],
    "grammar": [
      {
        "title": "Motion Verb System\n\n| | On Foot | By Vehicle |\n|---|---------|------------|\n| **Unidirectional (now)** | идти́ (иду́, идёшь) | е́хать (е́ду, е́дешь) |\n| **Multidirectional (regular)** | ходи́ть (хожу́, хо́дишь) | е́здить (е́зжу, е́здишь) |\n| **Past (process)** | шёл, шла, шли | е́хал, е́хала, е́хали |\n| **Past (round trip)** | ходи́л, ходи́ла | е́здил, е́здила |",
        "desc": ""
      }
    ]
  },
  "26": {
    "title_ru": "Е́сли бы...",
    "title_en": "If Only...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Что бы вы сде́лали, е́сли бы вы́играли миллио́н?",
        "en": "What would you do if you won a million?"
      },
      {
        "speaker": "Б:",
        "ru": "Я бы купи́л дом у мо́ря.",
        "en": "I would buy a house by the sea."
      },
      {
        "speaker": "А:",
        "ru": "А рабо́тать бы продолжа́ли?",
        "en": "Would you continue working?"
      },
      {
        "speaker": "Б:",
        "ru": "Наве́рное, нет. Я бы путеше́ствовал.",
        "en": "Probably not. I would travel."
      },
      {
        "speaker": "А:",
        "ru": "Зву́чит прекра́сно!",
        "en": "Sounds wonderful!"
      }
    ],
    "grammar": [
      {
        "title": "Forming the Conditional\n\n**Formula:** Past tense form + БЫ\n\n| Past Tense | + БЫ | English |\n|------------|------|---------|\n| Я сде́лал | Я бы сде́лал | I would do |\n| Она́ пошла́ | Она́ бы пошла́ | She would go |\n| Мы купи́ли | Мы бы купи́ли | We would buy |\n| Они́ сказа́ли | Они́ бы сказа́ли | They would say |",
        "desc": ""
      }
    ]
  },
  "27": {
    "title_ru": "Что́бы...",
    "title_en": "In Order To...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Заче́м вы пришли́?",
        "en": "Why did you come?"
      },
      {
        "speaker": "Б:",
        "ru": "Я пришёл, что́бы поговори́ть с дире́ктором.",
        "en": "I came to talk with the director."
      },
      {
        "speaker": "А:",
        "ru": "А для чего́?",
        "en": "And for what purpose?"
      },
      {
        "speaker": "Б:",
        "ru": "Что́бы обсуди́ть но́вый прое́кт.",
        "en": "To discuss a new project."
      },
      {
        "speaker": "А:",
        "ru": "Поня́тно. Подожди́те, пожа́луйста.",
        "en": "I see. Please wait."
      }
    ],
    "grammar": [
      {
        "title": "ЧТО́БЫ + Infinitive (Same Subject)\n\nWhen the subject is the same in both clauses:\n\n| Russian | English |\n|---------|---------|\n| Я пришёл, **что́бы помо́чь**. | I came to help. |\n| Она́ учи́тся, **что́бы получи́ть дипло́м**. | She studies to get a diploma. |\n| Мы рабо́таем, **что́бы жить**. | We work to live. |\n| Он встал ра́но, **что́бы успе́ть на по́езд**. | He got up early to catch the train. |",
        "desc": ""
      }
    ]
  },
  "28": {
    "title_ru": "Говоря́т, что...",
    "title_en": "They Say That...",
    "dialogue": [
      {
        "speaker": "А:",
        "ru": "Ты слы́шал но́вости?",
        "en": "Did you hear the news?"
      },
      {
        "speaker": "Б:",
        "ru": "Каки́е?",
        "en": "What news?"
      },
      {
        "speaker": "А:",
        "ru": "Говоря́т, что Ива́н жени́тся!",
        "en": "They say Ivan is getting married!"
      },
      {
        "speaker": "Б:",
        "ru": "Пра́вда? Кто сказа́л?",
        "en": "Really? Who said?"
      },
      {
        "speaker": "А:",
        "ru": "Ма́ша сказа́ла, что он ей сам расска́зал.",
        "en": "Masha said he told her himself."
      },
      {
        "speaker": "Б:",
        "ru": "Ну наде́юсь, что э́то пра́вда.",
        "en": "Well, I hope it's true."
      }
    ],
    "grammar": [
      {
        "title": "Direct vs Indirect Speech\n\n| Direct | Indirect |\n|--------|----------|\n| Он сказа́л: «Я приду́ за́втра.» | Он сказа́л, **что** он придёт за́втра. |\n| He said: \"I will come tomorrow.\" | He said that he would come tomorrow. |",
        "desc": ""
      }
    ]
  },
  "29": {
    "title_ru": "Разгово́рный ру́сский",
    "title_en": "Colloquial Russian",
    "dialogue": [
      {
        "speaker": "Ру́сский",
        "ru": "English",
        "en": "Notes"
      },
      {
        "speaker": "— Ну что, как дела́?",
        "ru": "So, how's it going?",
        "en": "Ну = well/so"
      },
      {
        "speaker": "— Да норма́льно. А ты как?",
        "ru": "Fine. And you?",
        "en": "Да = here: just"
      },
      {
        "speaker": "— Да ничего́, вро́де.",
        "ru": "Okay, I guess.",
        "en": "Ничего́ = not bad"
      },
      {
        "speaker": "— Слу́шай, а ты чё сего́дня де́лаешь?",
        "ru": "Hey, what are you doing today?",
        "en": "Чё = что (informal)"
      },
      {
        "speaker": "— Да ниче́. Мо́жет, ку́да схо́дим?",
        "ru": "Nothing much. Maybe go somewhere?",
        "en": "Ниче́ = ничего́"
      },
      {
        "speaker": "— Ага́, тип того́.",
        "ru": "Yeah, something like that.",
        "en": "Тип того́ = sort of"
      }
    ],
    "grammar": [
      {
        "title": "Essential Particles\n\n| Particle | Meaning/Use | Example |\n|----------|-------------|---------|\n| **ну** | well, so, come on | Ну, пошли́! (Come on, let's go!) |\n| **же** | emphasis (you know!) | Ты же зна́ешь! (You know!) |\n| **ведь** | after all, you see | Я ведь говори́л! (I told you so!) |\n| **вот** | here, this, see | Вот ви́дишь! (See!) |\n| **да** | yes / just / well | Да ла́дно! (Come on! / Really?) |\n| **то́лько** | just, only | Я то́лько пришёл. (I just arrived.) |\n| **уже́** | already | Уже́ пора́! (It's time already!) |\n| **ещё** | still, more | Ещё чего́! (No way!) |",
        "desc": ""
      }
    ]
  }
};


    // Set register (formal/informal)
    function setRegister(reg) {
      register = reg;
      document.getElementById('formalBtn').classList.toggle('active', reg === 'formal');
      document.getElementById('informalBtn').classList.toggle('active', reg === 'informal');
      // Update current drill display
      updateDrillDisplay();
    }

    // Open a unit - show detail view with dialogue, grammar, drills
    function openUnit(unitId) {
      currentUnit = unitId;
      const unit = UNIT_DATA[unitId];
      if (!unit) return;

      // Update title
      document.getElementById('unitDetailTitle').textContent = `UNIT ${unitId}: ${unit.title_ru}`;

      // Render dialogue
      const dialogueHtml = unit.dialogue.map(line => `
        <div style="margin-bottom: 10px;">
          <strong style="color: var(--accent-blue);">${line.speaker}:</strong>
          <span style="color: var(--text);">${line.ru}</span>
          <br>
          <span style="color: var(--text-dim); font-size: 14px;">${line.en}</span>
        </div>
      `).join('');
      document.getElementById('dialogueContent').innerHTML = dialogueHtml;

      // Render grammar intro
      const grammarHtml = unit.grammar.map(g => `
        <div style="margin-bottom: 12px;">
          <strong style="color: #8B4513;">${g.title}</strong>
          <div style="margin-top: 4px;">${g.desc}</div>
        </div>
      `).join('');
      document.getElementById('grammarIntroContent').innerHTML = grammarHtml;

      // Update drill count
      const unitDrills = drillsData ? drillsData.drills.filter(d => d.unit === unitId) : [];
      console.log('openUnit:', unitId, 'type:', typeof unitId, 'found:', unitDrills.length, 'drills');
      if (drillsData && unitDrills.length === 0) {
        console.log('Sample drill units:', drillsData.drills.slice(0,3).map(d => ({id: d.id, unit: d.unit, type: typeof d.unit})));
      }
      document.getElementById('drillCount').textContent = unitDrills.length;

      // Show unit detail view, hide others
      document.getElementById('linearView').style.display = 'none';
      document.getElementById('srsView').style.display = 'none';
      document.getElementById('unitDetailView').style.display = 'block';
    }

    // Close unit detail view
    function closeUnitDetail() {
      document.getElementById('unitDetailView').style.display = 'none';
      document.getElementById('linearView').style.display = 'block';
    }

    // Play dialogue with pre-generated ElevenLabs audio
    let dialogueAudio = null;
    function playDialogue() {
      const unit = UNIT_DATA[currentUnit];
      if (!unit) return;

      // Stop any currently playing audio
      if (dialogueAudio) {
        dialogueAudio.pause();
        dialogueAudio = null;
      }

      // Use pre-generated MP3 from audio folder
      const unitNum = String(currentUnit).padStart(2, '0');
      const audioPath = `audio/unit${unitNum}_dialogue.mp3`;

      dialogueAudio = new Audio(audioPath);
      dialogueAudio.onerror = () => {
        // Fallback to browser TTS if audio file not found
        console.log('Audio file not found, using browser TTS');
        let index = 0;
        function speakNext() {
          if (index >= unit.dialogue.length) return;
          const line = unit.dialogue[index];
          const utterance = new SpeechSynthesisUtterance(line.ru);
          utterance.lang = 'ru-RU';
          utterance.rate = 0.85;
          utterance.onend = () => {
            index++;
            setTimeout(speakNext, 500);
          };
          speechSynthesis.speak(utterance);
        }
        speakNext();
      };
      dialogueAudio.play();
    }

    // Start drills from unit detail view
    function startUnitDrills() {
      loadUnitDrills(currentUnit);
    }

    // Start dialogue as drills - practice typing the dialogue lines
    function startDialogueDrills() {
      const unit = UNIT_DATA[currentUnit];
      if (!unit || !unit.dialogue) {
        alert('No dialogue available for this unit.');
        return;
      }

      // Convert dialogue lines to drill format
      currentDrills = unit.dialogue.map((line, index) => ({
        id: `dialogue_${currentUnit}_${index}`,
        type: 'DIALOGUE',
        russian: line.ru,
        russian_informal: line.ru,
        english: `${line.speaker}: ${line.en}`,
        speaker: line.speaker,
        commonality: 1.0
      }));

      currentDrillIndex = 0;
      sessionCorrect = 0;
      sessionTotal = 0;

      // Hide unit detail, show drill view
      document.getElementById('unitDetailView').style.display = 'none';
      showDrill();
    }

    // Load drills for a unit
    function loadUnitDrills(unitId) {
      if (!drillsData) {
        console.error('Drills data not loaded');
        return;
      }

      // Filter drills for this unit from the database
      const unitDrills = drillsData.drills.filter(d => d.unit === unitId);

      if (unitDrills.length === 0) {
        alert(`No drills available for Unit ${unitId} yet.`);
        return;
      }

      // Get seen drills from progress
      const progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const seenDrills = progress.seenDrills || {};

      // Convert to display format
      currentDrills = unitDrills.map(d => ({
        id: d.id,
        type: d.type,
        russian: d.russian_formal,
        russian_informal: d.russian_informal,
        english: d.english,
        pos_pattern: d.pos_pattern,
        commonality: d.commonality,
        seen: !!seenDrills[d.id]
      }));

      // Sort: unseen first (by commonality), then seen
      currentDrills.sort((a, b) => {
        if (a.seen !== b.seen) return a.seen ? 1 : -1;
        return b.commonality - a.commonality;
      });

      currentDrillIndex = 0;
      console.log('Unit drills:', currentDrills.length, 'unseen:', currentDrills.filter(d => !d.seen).length);
      sessionCorrect = 0;
      sessionTotal = 0;

      // Hide unit detail, show drill view
      document.getElementById('unitDetailView').style.display = 'none';
      showDrill();
    }

    // Update SRS statistics display
    function updateSRSStats() {
      if (typeof FSI_SRS === 'undefined') return;

      const stats = FSI_SRS.getStats();
      document.getElementById('dueToday').textContent = stats.due_today || drillsData?.total_drills || 0;
      document.getElementById('newCards').textContent = stats.new || drillsData?.total_drills || 0;
      document.getElementById('reviewCards').textContent = stats.review || 0;
      document.getElementById('masteredCards').textContent = stats.mastered || 0;

      // Update accuracy
      if (sessionTotal > 0) {
        const acc = Math.round((sessionCorrect / sessionTotal) * 100);
        document.getElementById('accuracy').textContent = acc;
      }
    }

    // Review units (6, 12, 18, 24) - these are refresher/revision units
    const REVIEW_UNITS = [6, 12, 18, 24];

    // Check if user has completed Unit 1 (all Unit 1 drills reviewed at least once)
    function hasCompletedUnit1() {
      const progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const unit1Drills = drillsData.drills.filter(d => d.unit === 1);
      const seenCount = unit1Drills.filter(d => progress.seenDrills?.[d.id]).length;
      return seenCount >= unit1Drills.length * 0.8; // 80% threshold
    }

    // Start SRS session
    function startSRSSession() {
      if (!drillsData) {
        alert('Drills not loaded. If using file://, try a local server.');
        return;
      }

      const unit1Complete = hasCompletedUnit1();

      // Build drill queue with unit info and review unit tagging
      currentDrills = drillsData.drills.filter(d => d.unit <= 12).map(d => ({
        id: d.id,
        type: d.type,
        russian: d.russian_formal,
        russian_informal: d.russian_informal,
        english: d.english,
        pos_pattern: d.pos_pattern,
        commonality: d.commonality,
        unit: d.unit,
        isReviewUnit: REVIEW_UNITS.includes(d.unit),
        singleSentenceMode: unit1Complete  // After Unit 1, show 1 sentence at a time
      }));

      // Sort by commonality (most common first), but boost non-review units slightly
      currentDrills.sort((a, b) => {
        const aScore = a.commonality + (a.isReviewUnit ? -0.1 : 0);
        const bScore = b.commonality + (b.isReviewUnit ? -0.1 : 0);
        return bScore - aScore;
      });

      // Limit to 20 cards per session
      currentDrills = currentDrills.slice(0, 20);

      if (currentDrills.length === 0) {
        alert('No cards available!');
        return;
      }

      currentDrillIndex = 0;
      sessionCorrect = 0;
      sessionTotal = 0;
      currentMode = 'srs';

      document.getElementById('srsView').style.display = 'none';
      showDrill();
    }

    // Show drill view
    function showDrill() {
      document.getElementById('drillView').classList.add('active');
      document.getElementById('linearView').style.display = 'none';
      updateDrillDisplay();
    }

    // Update drill display
    function updateDrillDisplay() {
      const drill = currentDrills[currentDrillIndex];
      if (!drill) return;

      // Reset retry mode for new drill
      retryMode = false;
      retryExpected = '';

      document.getElementById('drillType').textContent = drill.type.toUpperCase();
      document.getElementById('drillProgress').textContent = `${currentDrillIndex + 1} / ${currentDrills.length}`;

      let russianText = drill.russian;
      // Apply tu conversion if informal
      if (register === 'informal') {
        russianText = convertToTu(russianText);
      }

      const promptFr = document.getElementById('promptFr');
      const promptEn = document.getElementById('promptEn');
      const grammarHints = document.getElementById('grammarHints');
      const hintsContent = document.getElementById('hintsContent');

      promptFr.textContent = russianText;
      promptEn.textContent = drill.english || '(translate to Russian)';

      // Handle drill mode display
      if (drillMode === 'translate') {
        // Translation mode: show English prompt, hide Russian answer, show grammar hints
        if (drill.english && drill.english.trim()) {
          // Has English - show English, hide Russian
          promptEn.style.display = 'block';
          promptEn.style.fontSize = '20px';
          promptFr.style.display = 'none';
        } else {
          // No English - show Russian with instruction to type it
          promptEn.textContent = '(Type the Russian sentence below)';
          promptEn.style.display = 'block';
          promptEn.style.fontSize = '14px';
          promptFr.style.display = 'block';
          promptFr.style.fontSize = '20px';
        }
        grammarHints.style.display = 'block';
        hintsContent.textContent = generateGrammarHints(russianText, drill.english || '');
      } else {
        // Repeat mode: show Russian to copy, English below, no hints
        promptFr.style.display = 'block';
        promptFr.style.fontSize = '22px';
        promptEn.style.display = 'block';
        promptEn.style.fontSize = '14px';
        grammarHints.style.display = 'none';
      }

      // Reset input
      const input = document.getElementById('userInput');
      input.value = '';
      input.className = '';
      input.focus();

      // Reset feedback
      document.getElementById('feedback').classList.remove('show', 'success', 'error');

      // Reset buttons
      document.getElementById('checkBtn').style.display = 'inline-block';
      document.getElementById('nextBtn').style.display = 'none';
    }

    // Convert formal to informal
    function convertToTu(text) {
      return text
        .replace(/\bvous\b/gi, 'tu')
        .replace(/\bvotre\b/gi, 'ton')
        .replace(/\bvos\b/gi, 'tes')
        .replace(/\ballez\b/gi, 'vas')
        .replace(/\bavez\b/gi, 'as')
        .replace(/\bêtes\b/gi, 'es')
        .replace(/Comment allez-vous/gi, 'Comment vas-tu');
    }

    // Check answer
    function checkAnswer() {
      const input = document.getElementById('userInput');
      const drill = currentDrills[currentDrillIndex];

      let expected = drill.russian;
      if (register === 'informal') {
        expected = convertToTu(expected);
      }

      // Use error classifier
      const result = FSI_Error.classify(input.value, expected);

      const feedback = document.getElementById('feedback');
      const feedbackTitle = document.getElementById('feedbackTitle');
      const feedbackDetail = document.getElementById('feedbackDetail');
      const drillLink = document.getElementById('drillLink');
      const checkBtn = document.getElementById('checkBtn');
      const nextBtn = document.getElementById('nextBtn');

      // Handle retry mode - user got it wrong before and must type correctly
      if (retryMode) {
        if (result.correct) {
          input.className = 'correct';
          feedback.className = 'feedback show success';
          feedbackTitle.textContent = 'Хорошо!';
          feedbackDetail.textContent = 'Теперь правильно. Продолжаем...';
          drillLink.style.display = 'none';
          AudioFeedback.correct();

          // Exit retry mode and auto-advance (don't count for stats)
          retryMode = false;
          retryExpected = '';
          checkBtn.style.display = 'none';
          checkBtn.textContent = 'CHECK';
          nextBtn.style.display = 'none';
          setTimeout(function() { nextDrill(); }, 1000);
        } else {
          // Still wrong - clear and let them try again
          AudioFeedback.incorrect();
          input.value = '';
          input.className = '';
          feedback.className = 'feedback show error';
          feedbackTitle.textContent = 'Ещё раз';
          feedbackDetail.textContent = 'Напишите: ' + expected;
        }
        return;
      }

      if (result.correct) {
        input.className = 'correct';
        feedback.className = 'feedback show success';
        drillLink.style.display = 'none';

        // Handle accent warnings
        if (result.accentWarning) {
          feedbackTitle.textContent = 'Правильно!';
          feedbackDetail.innerHTML = `<span style="color: #856404;">Обратите внимание:</span> <strong>${expected}</strong>`;
          feedback.className = 'feedback show success accent-warning';
        } else {
          feedbackTitle.textContent = 'Правильно!';
          feedbackDetail.textContent = expected;
        }

        AudioFeedback.correct();

        // Track correct answer
        sessionCorrect++;
        sessionTotal++;

        // Update SRS storage with review result
        Storage.reviewCard(drill.id, 2);  // quality=2 (good)
        Storage.setUnitProgress(currentUnit, currentDrillIndex, drill.id);

        // Auto-advance after 1 second
        setTimeout(() => nextDrill(), 1000);
      } else {
        input.className = 'incorrect';
        feedback.className = 'feedback show error';
        feedbackTitle.textContent = 'Неправильно';
        feedbackDetail.innerHTML = result.feedback.replace(/\n/g, '<br>');
        sessionTotal++;

        AudioFeedback.incorrect();

        if (result.primaryError?.drillLink) {
          drillLink.textContent = `Повторить: ${result.primaryError.drillLink}`;
          drillLink.style.display = 'inline-block';
        } else {
          drillLink.style.display = 'none';
        }

        // SRS: Add wrong drill back to queue for later review
        if (currentMode === 'srs') {
          const wrongDrill = {...drill, wrongCount: (drill.wrongCount || 0) + 1};
          // Insert it 3-5 drills later for immediate reinforcement
          const insertAt = Math.min(currentDrillIndex + 3 + Math.floor(Math.random() * 3), currentDrills.length);
          currentDrills.splice(insertAt, 0, wrongDrill);
        }

        Storage.reviewCard(drill.id, 1);  // quality=1 (again)

        // Enable retry mode - user must type correct answer before continuing
        retryMode = true;
        retryExpected = expected;
        input.value = '';  // Clear input for retry
        input.className = '';  // Reset styling
        checkBtn.textContent = 'ЕЩЁ РАЗ';
        // Keep CHECK button visible, don't show NEXT yet
      }
    }

    // Next drill
    function nextDrill() {
      currentDrillIndex++;
      if (currentDrillIndex >= currentDrills.length) {
        // Session complete
        closeDrill();
        const acc = sessionTotal > 0 ? Math.round((sessionCorrect / sessionTotal) * 100) : 0;
        alert(`Session Complete!\n\nCorrect: ${sessionCorrect}/${sessionTotal}\nAccuracy: ${acc}%`);
      } else {
        updateDrillDisplay();
      }
    }

    // Show hint
    function showHint() {
      const drill = currentDrills[currentDrillIndex];
      let expected = drill.russian;
      if (register === 'informal') {
        expected = convertToTu(expected);
      }
      // Show first few characters
      const hint = expected.substring(0, Math.min(10, expected.length)) + '...';
      alert('Hint: ' + hint);
    }

    // Skip drill
    function skipDrill() {
      nextDrill();
    }

    // Close drill view
    function closeDrill() {
      document.getElementById('drillView').classList.remove('active');
      // Return to correct view based on current mode
      if (currentMode === 'srs') {
        document.getElementById('srsView').style.display = 'block';
      } else if (currentUnit) {
        // Return to unit detail view if we came from a unit
        document.getElementById('unitDetailView').style.display = 'block';
      } else {
        document.getElementById('linearView').style.display = 'block';
      }
    }

    // Play audio - use generated MP3 if available, fallback to TTS
    let currentAudio = null;
    let audioFallbackUsed = false;

    let audioEndCallback = null;

    function playAudio(lang = 'ru', onComplete = null) {
      // Stop ALL audio first
      speechSynthesis.cancel();
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.src = '';
        currentAudio = null;
      }
      audioFallbackUsed = false;
      audioEndCallback = onComplete;

      const drill = currentDrills[currentDrillIndex];
      if (!drill) {
        if (onComplete) onComplete();
        return;
      }

      // Use audio mapping if available (maps drill ID to correct audio file)
      const audioFileId = drill.id;  // Direct - audio files named by drill ID
      const audioFile = `audio/drills/${audioFileId}_${lang}.mp3?t=${Date.now()}`;
      console.log('Loading audio:', drill.id, '->', audioFileId, lang);

      // Check if MP3 exists first
      currentAudio = new Audio();
      
      const useTTSFallback = () => {
        if (audioFallbackUsed) return;
        audioFallbackUsed = true;
        currentAudio = null;

        // Always read from screen to ensure sync
        const text = lang === 'ru'
          ? document.getElementById('promptFr').textContent
          : document.getElementById('promptEn').textContent;
        if (!text) {
          if (audioEndCallback) audioEndCallback();
          return;
        }

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang === 'ru' ? 'ru-RU' : 'en-GB';
        utterance.rate = 0.9;
        utterance.onend = () => { if (audioEndCallback) audioEndCallback(); };
        speechSynthesis.speak(utterance);
      };

      // Only play if file loads successfully
      currentAudio.oncanplaythrough = () => {
        if (!audioFallbackUsed) {
          currentAudio.play().catch(() => {});
        }
      };

      currentAudio.onended = () => { if (audioEndCallback) audioEndCallback(); };
      currentAudio.onerror = useTTSFallback;

      // Try MP3 first, fall back to TTS if error
      currentAudio.src = audioFile;
      
      // Timeout fallback if load takes too long
      setTimeout(() => {
        if (!audioFallbackUsed && currentAudio && currentAudio.readyState < 3) {
          useTTSFallback();
        }
      }, 1000);
    }

    function playAudioEn() {
      playAudio('en');
    }

    // ============================================
    // VOICE RECOGNITION - Optimized for Non-Native Speakers
    // ============================================

    let recognition = null;
    let isRecording = false;
    let handsFreeMode = false;
    let handsFreeActive = false;
    let slowMode = false;
    let listenTimeout = null;

    // Normalize text for comparison (strip accents, lowercase, remove punctuation)
    function normalizeForComparison(text) {
      return text
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')  // Strip accents
        .replace(/[^a-z0-9\s]/g, '')  // Remove punctuation
        .replace(/\s+/g, ' ')  // Normalize spaces
        .trim();
    }

    // Fuzzy match for non-native speakers (allows ~30% error)
    function fuzzyMatch(spoken, expected) {
      const s = normalizeForComparison(spoken);
      const e = normalizeForComparison(expected);

      // Exact match after normalization
      if (s === e) return { match: true, score: 100 };

      // Check word-by-word similarity
      const spokenWords = s.split(' ').filter(w => w.length > 0);
      const expectedWords = e.split(' ').filter(w => w.length > 0);

      let matchedWords = 0;
      for (const sw of spokenWords) {
        for (const ew of expectedWords) {
          if (sw === ew || levenshteinSimilarity(sw, ew) > 0.6) {
            matchedWords++;
            break;
          }
        }
      }

      const score = (matchedWords / Math.max(spokenWords.length, expectedWords.length)) * 100;
      return { match: score >= 60, score: Math.round(score) };  // 60% threshold for non-natives
    }

    // Levenshtein similarity (0-1)
    function levenshteinSimilarity(a, b) {
      if (a.length === 0) return b.length === 0 ? 1 : 0;
      if (b.length === 0) return 0;

      const matrix = [];
      for (let i = 0; i <= b.length; i++) matrix[i] = [i];
      for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          const cost = a[j-1] === b[i-1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i-1][j] + 1,
            matrix[i][j-1] + 1,
            matrix[i-1][j-1] + cost
          );
        }
      }

      const maxLen = Math.max(a.length, b.length);
      return 1 - (matrix[b.length][a.length] / maxLen);
    }

    // Initialize speech recognition
    function initVoiceRecognition() {
      // Reuse existing recognition object to avoid permission prompts
      if (recognition) return true;
      
    // Whisper API for better speech recognition
    const WHISPER_API_URL = "https://api.rhodesagi.com/whisper/transcribe";
    let useWhisper = true;
    let mediaRecorder = null;
    let audioChunks = [];
    
    async function transcribeWithWhisper(audioBlob, lang) {
      const formData = new FormData();
      formData.append("audio", audioBlob, "recording.webm");
      formData.append("language", lang || "de");
      try {
        const response = await fetch(WHISPER_API_URL, { method: "POST", body: formData });
        if (!response.ok) throw new Error("Whisper API error");
        const data = await response.json();
        return data.text || "";
      } catch (err) {
        console.error("Whisper failed:", err);
        return null;
      }
    }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        console.warn('Speech recognition not supported');
        document.getElementById('micBtn').classList.add('disabled');
        return false;
      }

      recognition = new SpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.continuous = true;  // Keep listening until timeout
      recognition.interimResults = true;
      recognition.maxAlternatives = 5;

      recognition.onstart = () => {
        isRecording = true;
        document.getElementById('micBtn').classList.add('recording');
        document.getElementById('voiceStatus').textContent = '🎤 Listening...';
        document.getElementById('voiceStatus').style.color = '#dc3545';
        
        // Calculate timeout based on expected response length
        const drill = currentDrills[currentDrillIndex];
        const expectedLen = drill?.russian?.length || 20;
        // ~100ms per character + base time, more in slow mode
        const baseTime = slowMode ? 4000 : 2500;
        const perCharTime = slowMode ? 120 : 80;
        const timeout = baseTime + (expectedLen * perCharTime);
        
        if (listenTimeout) clearTimeout(listenTimeout);
        listenTimeout = setTimeout(() => {
          if (isRecording && recognition) {
            recognition.stop();
          }
        }, timeout);
      };

      recognition.onresult = (event) => {
        const results = event.results;
        const lastResult = results[results.length - 1];

        if (lastResult.isFinal) {
          // Try all alternatives to find best match
          const drill = currentDrills[currentDrillIndex];
          const expected = drill.russian;

          let bestTranscript = lastResult[0].transcript;
          let bestScore = 0;

          for (let i = 0; i < lastResult.length; i++) {
            const alt = lastResult[i].transcript;
            const result = fuzzyMatch(alt, expected);
            if (result.score > bestScore) {
              bestScore = result.score;
              bestTranscript = alt;
            }
          }

          document.getElementById('userInput').value = bestTranscript;
          document.getElementById('voiceStatus').textContent = 'Heard: "' + bestTranscript + '" (' + bestScore + '% match)';
          document.getElementById('voiceStatus').style.color = bestScore >= 60 ? '#28a745' : '#ffc107';

          // Auto-check in hands-free mode
          if (handsFreeMode) {
            setTimeout(() => checkVoiceAnswer(bestTranscript, expected), 300);
          }
        } else {
          document.getElementById('voiceStatus').textContent = '🎤 "' + lastResult[0].transcript + '"...';
        }
      };

      recognition.onerror = (event) => {
        let msg = '';
        switch(event.error) {
          case 'no-speech': msg = 'No speech heard - try again'; break;
          case 'audio-capture': msg = 'No microphone found'; break;
          case 'not-allowed': msg = 'Mic blocked - allow in browser'; break;
          default: msg = event.error;
        }
        document.getElementById('voiceStatus').textContent = msg;
        document.getElementById('voiceStatus').style.color = '#dc3545';
        stopRecording();

        // In hands-free, retry after a pause
        if (handsFreeMode && event.error === 'no-speech') {
          setTimeout(() => startListening(), 2000);
        }
      };

      recognition.onend = () => {
        stopRecording();
      };

      return true;
    }

    function checkVoiceAnswer(spoken, expected) {
      const result = fuzzyMatch(spoken, expected);
      const drill = currentDrills[currentDrillIndex];

      if (result.match) {
        // Good enough for a non-native speaker!
        document.getElementById('userInput').value = expected;  // Show correct version
        document.getElementById('voiceStatus').textContent = 'Correct! (' + result.score + '%)';
        document.getElementById('voiceStatus').style.color = '#28a745';

        // Trigger success
        const input = document.getElementById('userInput');
        input.className = 'correct';
        const feedback = document.getElementById('feedback');
        feedback.className = 'feedback show success';
        document.getElementById('feedbackTitle').textContent = 'Correct!';
        document.getElementById('feedbackDetail').textContent = expected;

        sessionCorrect++;
        sessionTotal++;

        // Save progress
        // Update SRS storage with review result
        Storage.reviewCard(drill.id, 2);  // quality=2 (good)
        Storage.setUnitProgress(currentUnit, currentDrillIndex, drill.id);

        // Play Russian confirmation, then auto-advance
        if (handsFreeMode) {
          playAudio('ru', () => {
            // After confirmation finishes, advance to next
            setTimeout(() => {
              nextDrill();
              setTimeout(() => startHandsFreeFlow(), 300);
            }, 300);
          });
        } else {
          setTimeout(() => nextDrill(), 1500);
        }
      } else {
        // Show what was expected
        document.getElementById('voiceStatus').textContent = 'Try again (' + result.score + '%)';
        document.getElementById('voiceStatus').style.color = '#dc3545';

        const feedback = document.getElementById('feedback');
        feedback.className = 'feedback show error';
        document.getElementById('feedbackTitle').textContent = 'Not quite';
        document.getElementById('feedbackDetail').innerHTML = 'You said: "' + spoken + '"<br>Expected: "' + expected + '"';

        sessionTotal++;

        // SRS: Re-queue wrong drill
        if (currentMode === 'srs') {
          const wrongDrill = {...drill, wrongCount: (drill.wrongCount || 0) + 1};
          const insertAt = Math.min(currentDrillIndex + 3 + Math.floor(Math.random() * 3), currentDrills.length);
          currentDrills.splice(insertAt, 0, wrongDrill);
        }

        // In hands-free, replay Russian then listen again
        if (handsFreeMode) {
          setTimeout(() => {
            playAudio('ru', () => {
              // After replay finishes, listen for retry
              setTimeout(() => startListening(), 300);
            });
          }, 1500);  // Brief pause to read feedback
        }
      }
    }

    function toggleVoiceInput() {
      if (!recognition && !initVoiceRecognition()) {
        alert('Voice not supported. Use Chrome or Edge.');
        return;
      }

      if (isRecording) {
        recognition.stop();
      } else {
        startListening();
      }
    }

    function startListening() {
      if (!recognition) initVoiceRecognition();
      if (isRecording) return;

      // HARD STOP all audio before listening
      speechSynthesis.cancel();
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.src = '';
        currentAudio = null;
      }

      document.getElementById('userInput').value = '';
      try {
        recognition.start();
      } catch (e) {
        setTimeout(() => startListening(), 200);
      }
    }

    function stopRecording() {
      isRecording = false;
      document.getElementById('micBtn').classList.remove('recording');
    }

    // TRUE HANDS-FREE FLOW
    function startHandsFreeFlow() {
      if (!handsFreeMode) return;
      handsFreeActive = true;

      const drill = currentDrills[currentDrillIndex];
      if (!drill) {
        handsFreeActive = false;
        return;
      }

      document.getElementById('voiceStatus').textContent = 'Playing audio...';
      document.getElementById('voiceStatus').style.color = '#666';

      // Play prompt, wait for it to END, then listen
      playAudio('en', () => {
        // Ensure audio fully stopped before listening
        speechSynthesis.cancel();
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
        setTimeout(() => {
          document.getElementById('voiceStatus').textContent = '🎤 Say it in Russian!';
          startListening();
        }, 300);
      });
    }

    function setupHandsFreeMode() {
      const checkbox = document.getElementById('handsFreeMode');
      const slowCheckbox = document.getElementById('slowMode');
      
      // Slow mode toggle
      slowCheckbox.addEventListener('change', (e) => {
        slowMode = e.target.checked;
      });
      
      checkbox.addEventListener('change', (e) => {
        handsFreeMode = e.target.checked;

        if (handsFreeMode) {
          if (!recognition) initVoiceRecognition();
          document.getElementById('voiceStatus').textContent = 'Hands-free ON';
          document.getElementById('voiceStatus').style.color = '#28a745';

          // Start if already in a drill
          if (document.getElementById('drillView').classList.contains('active')) {
            startHandsFreeFlow();
          }
        } else {
          handsFreeActive = false;
          if (recognition && isRecording) recognition.stop();
          document.getElementById('voiceStatus').textContent = '';
        }
      });
    }

    // Hook into drill display updates
    const originalUpdateDrillDisplay = updateDrillDisplay;
    updateDrillDisplay = function() {
      originalUpdateDrillDisplay();

      if (handsFreeMode) {
        setTimeout(() => startHandsFreeFlow(), 500);
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupHandsFreeMode();
      initVoiceRecognition();
    });


    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('drillView').classList.contains('active')) return;

      if (e.key === 'Enter') {
        if (document.getElementById('nextBtn').style.display !== 'none') {
          nextDrill();
        } else {
          checkAnswer();
        }
      } else if (e.key === 'Tab') {
        e.preventDefault();
        showHint();
      } else if (e.key === 'Escape') {
        closeDrill();
      }
    });

    // Initialize
    loadCourse();
  </script>
</body>
</html>
<!-- Trigger rebuild Wed Dec 31 12:43:42 PM EST 2025 -->
